<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>æ™ºå†œäº‘ Â· å†œä¸šç®¡ç†å¹³å°</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CSS VARIABLES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:          #F7FAF7;
  --bg2:         #FFFFFF;
  --surface:     #EEF6EE;
  --card:        #FFFFFF;
  --card2:       #F2F8F2;
  --border:      rgba(46,125,50,0.14);
  --border2:     rgba(46,125,50,0.08);
  --green:       #2E7D32;
  --green-light: #4CAF50;
  --green-dim:   rgba(46,125,50,0.08);
  --amber:       #E65100;
  --amber-dim:   rgba(230,81,0,0.08);
  --red:         #C62828;
  --red-dim:     rgba(198,40,40,0.08);
  --blue:        #1565C0;
  --blue-dim:    rgba(21,101,192,0.08);
  --lime:        #33691E;
  --lime-dim:    rgba(51,105,30,0.08);
  --text:        #1B2E1B;
  --text2:       #5A7A5A;
  --text3:       #9DB89C;
  --mono:        'DM Mono', monospace;
  --sans:        'Noto Sans SC', sans-serif;
  --r:           12px;
  --r2:          20px;
  --nav-h:       64px;
  --header-h:    56px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body { background: var(--bg); color: #1B2E1B; font-family: var(--sans); font-size: 14px; -webkit-font-smoothing: antialiased; }
button { border: none; background: none; cursor: pointer; font-family: var(--sans); color: inherit; }
input, textarea { font-family: var(--sans); color: #1B2E1B; background: none; border: none; outline: none; }
svg { fill: currentColor; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app { position: fixed; inset: 0; overflow: hidden; }
.page { position: absolute; inset: 0; display: flex; flex-direction: column; overflow: hidden; background: #F7FAF7; transition: transform .3s cubic-bezier(.4,0,.2,1), opacity .3s ease; }
.page.hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
.page.prev  { transform: translateX(-30%); opacity: 0; pointer-events: none; }
.page-body  { flex: 1; overflow-y: auto; padding-bottom: calc(var(--nav-h) + 16px); }
.page-body::-webkit-scrollbar { display: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hdr {
  height: var(--header-h); display: flex; align-items: center; padding: 0 16px;
  background: #FFFFFF;
  border-bottom: 1px solid var(--border2); box-shadow: 0 1px 4px rgba(46,125,50,.06); flex-shrink: 0; position: relative; z-index: 10;
}
.hdr-back { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #FFFFFF; }
.hdr-title { flex: 1; text-align: center; font-size: 16px; font-weight: 600; letter-spacing: .02em; }
.hdr-action { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav {
  position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-h);
  background: #FFFFFF; border-top: 1px solid var(--border); box-shadow: 0 -2px 12px rgba(46,125,50,.06);
  display: flex; align-items: center; z-index: 100;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 0; transition: .2s; opacity: .45; }
.nav-item.active { opacity: 1; }
.nav-item.active .nav-icon { color: #2E7D32; }
.nav-icon { font-size: 22px; line-height: 1; transition: filter .2s; }
.nav-label { font-size: 10px; font-weight: 500; letter-spacing: .03em; }
.nav-item.active .nav-label { color: #2E7D32; }
.nav-dot { position: absolute; top: 6px; right: 8px; width: 7px; height: 7px; border-radius: 50%; background: var(--red); border: 1.5px solid var(--bg2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card { background: #FFFFFF; border: 1px solid rgba(46,125,50,.09); border-radius: var(--r2); overflow: hidden; position: relative; box-shadow: 0 2px 12px rgba(46,125,50,.06); }
.card::before { content:''; display:none; }
.card-p { padding: 16px; }
.card-hd { padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border2); }
.card-hd-title { font-size: 13px; font-weight: 600; letter-spacing: .04em; text-transform: uppercase; color: #5A7A5A; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BADGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 500; font-family: var(--mono); }
.badge-green { background: rgba(46,125,50,.10); color: #2E7D32; }
.badge-amber { background: rgba(230,81,0,.08); color: #E65100; }
.badge-red   { background: rgba(198,40,40,.08);   color: #C62828; }
.badge-blue  { background: rgba(21,101,192,.08);  color: #1565C0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 20px; border-radius: var(--r); font-size: 14px; font-weight: 500; transition: .15s; }
.btn-primary { background: linear-gradient(135deg, #2E7D32, #43A047); color: #FFFFFF; box-shadow: 0 4px 16px rgba(46,125,50,.28); }
.btn-primary:active { background: #1B5E20; }
.btn-ghost { background: rgba(46,125,50,.06); color: #2E7D32; border: 1px solid rgba(46,125,50,.2); }
.btn-ghost:active { background: rgba(46,125,50,.14); }
.btn-danger { background: rgba(198,40,40,.08); color: #C62828; }
.btn-full { width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INPUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field { background: #F7FAF7; border: 1.5px solid rgba(46,125,50,.2); border-radius: var(--r); padding: 12px 14px; width: 100%; display: flex; align-items: center; gap: 10px; transition: border-color .2s; }
.field:focus-within { border-color: #2E7D32; background: #FFFFFF; }
.field input { flex: 1; font-size: 15px; color: #1B2E1B; }
.field input::placeholder { color: #9DB89C; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STAT GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.stat-box { background: #FFFFFF; border: 1px solid rgba(46,125,50,.10); border-radius: var(--r); padding: 14px; box-shadow: 0 1px 6px rgba(46,125,50,.06); }
.stat-val { font-family: var(--mono); font-size: 22px; font-weight: 500; }
.stat-label { font-size: 11px; color: #5A7A5A; margin-top: 4px; }
.stat-trend { font-family: var(--mono); font-size: 11px; margin-top: 6px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIST ROW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.list-row { display: flex; align-items: center; gap: 12px; padding: 13px 16px; border-bottom: 1px solid rgba(46,125,50,.08); }
.list-row:last-child { border-bottom: none; }
.list-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
.list-body { flex: 1; min-width: 0; }
.list-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-sub { font-size: 12px; color: #5A7A5A; margin-top: 2px; }
.list-right { text-align: right; flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROGRESS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-wrap { background: #E8F5E9; border-radius: 4px; height: 6px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #2E7D32, #66BB6A); transition: width 1s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec { padding: 0 16px; margin-top: 20px; }
.sec-hd { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.sec-title { font-size: 11px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: #5A7A5A; }
.sec-more { font-size: 12px; color: #2E7D32; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: #2E7D32; border-radius: 50%; animation: spin .6s linear infinite; margin: 40px auto; display: block; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast { position: fixed; bottom: calc(var(--nav-h) + 20px); left: 50%; transform: translateX(-50%) translateY(20px); background: #FFFFFF; border: 1px solid var(--border); padding: 10px 20px; border-radius: 24px; font-size: 13px; z-index: 999; opacity: 0; transition: all .3s; white-space: nowrap; pointer-events: none; }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAP PLACEHOLDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.map-box {
  background: #EEF6EE; border-radius: var(--r); overflow: hidden; position: relative;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 29px, rgba(46,125,50,.07) 29px, rgba(46,125,50,.07) 30px),
                    repeating-linear-gradient(90deg, transparent, transparent 29px, rgba(46,125,50,.07) 29px, rgba(46,125,50,.07) 30px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NDVI COLOR BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ndvi-bar { height: 16px; border-radius: 4px; background: linear-gradient(90deg, #C62828, #E65100, #F9A825, #66BB6A, #2E7D32); position: relative; }
.ndvi-pointer { position: absolute; top: -3px; width: 3px; height: 22px; background: #2E7D32; border-radius: 2px; transition: left .5s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PULSE DOT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pulse { width: 10px; height: 10px; border-radius: 50%; background: var(--green); position: relative; display: inline-block; }
.pulse::after { content:''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid var(--green); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%{opacity:1;transform:scale(1)} 100%{opacity:0;transform:scale(2)} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRONE TRACKER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.drone-track { position: relative; height: 240px; overflow: hidden; border-radius: var(--r); background: #EEF6EE;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(46,125,50,.06) 19px, rgba(46,125,50,.06) 20px),
                    repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(46,125,50,.06) 19px, rgba(46,125,50,.06) 20px);
}
.drone-icon { position: absolute; font-size: 24px; transition: left .8s ease, top .8s ease; transform: translate(-50%,-50%); filter: drop-shadow(0 2px 6px rgba(46,125,50,.4)); }
.drone-path { position: absolute; inset: 0; }
.flight-line { stroke: rgba(46,125,50,.45); stroke-width: 1.5; stroke-dasharray: 4 4; fill: none; }
.field-poly { fill: rgba(46,125,50,.08); stroke: #2E7D32; stroke-width: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAUGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.gauge-wrap { text-align: center; }
.gauge-svg { display: block; margin: 0 auto; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHIP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chip { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 12px; border: 1px solid var(--border); background: #FFFFFF; cursor: pointer; transition: .15s; color: #5A7A5A; }
.chip.active { background: rgba(46,125,50,.10); border-color: #2E7D32; color: #2E7D32; font-weight:600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALERT ITEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alert-item { padding: 12px 14px; border-radius: var(--r); display: flex; gap: 12px; align-items: flex-start; }
.alert-item + .alert-item { margin-top: 8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay { position: fixed; inset: 0; background: rgba(27,46,27,.45); z-index: 200; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity .3s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal-sheet { background: #FFFFFF; border-radius: 24px 24px 0 0; width: 100%; padding: 20px 20px 40px; transform: translateY(100%); transition: transform .3s cubic-bezier(.4,0,.2,1); border-top: 1px solid var(--border); box-shadow: 0 -8px 40px rgba(46,125,50,.12); }
.modal-overlay.open .modal-sheet { transform: translateY(0); }
.modal-handle { width: 40px; height: 4px; background: #C8E6C9; border-radius: 2px; margin: 0 auto 20px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#page-login { justify-content: flex-end; padding-bottom: 0; }
.login-bg {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse 90% 70% at 50% 0%, rgba(46,125,50,.18) 0%, rgba(102,187,106,.08) 50%, transparent 75%),
              linear-gradient(180deg, #E8F5E9 0%, #F7FAF7 60%, #FFFFFF 100%);
}
.login-art { position: absolute; top: 0; left: 0; right: 0; height: 45vh; display: flex; align-items: center; justify-content: center; }
.login-logo { font-size: 56px; filter: drop-shadow(0 4px 20px rgba(46,125,50,.25)); }
.login-brand { position: absolute; bottom: 60px; left: 0; right: 0; text-align: center; }
.login-brand-name { font-size: 28px; font-weight: 700; letter-spacing: .1em; }
.login-brand-sub { font-size: 12px; color: #5A7A5A; letter-spacing: .2em; text-transform: uppercase; margin-top: 4px; }
.login-form { background: #FFFFFF; border-radius: 28px 28px 0 0; padding: 28px 24px 48px; position: relative; z-index: 1; box-shadow: 0 -8px 40px rgba(46,125,50,.10); }
.login-tab { display: flex; background: #F2F8F2; border-radius: var(--r); padding: 4px; margin-bottom: 24px; border: 1px solid rgba(46,125,50,.12); }
.login-tab button { flex: 1; padding: 8px; border-radius: 8px; font-size: 14px; font-weight: 500; transition: .2s; color: #5A7A5A; }
.login-tab button.active { background: #2E7D32; color: #FFFFFF; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANIMATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
.fade-up { animation: fadeUp .4s ease both; }
.fade-up:nth-child(1){animation-delay:.0s}
.fade-up:nth-child(2){animation-delay:.06s}
.fade-up:nth-child(3){animation-delay:.12s}
.fade-up:nth-child(4){animation-delay:.18s}
.fade-up:nth-child(5){animation-delay:.24s}

@keyframes countUp { from{opacity:0} to{opacity:1} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOME HERO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.home-hero {
  padding: 20px 16px 24px;
  background: linear-gradient(145deg, #E8F5E9 0%, #F1F8E9 60%, #FFFFFF 100%);
  border-bottom: 1px solid rgba(46,125,50,.10);
}
.home-greeting { font-size: 12px; color: #5A7A5A; letter-spacing: .06em; text-transform: uppercase; }
.home-name { font-size: 22px; font-weight: 700; margin-top: 2px; }
.home-date { font-family: var(--mono); font-size: 11px; color: #9DB89C; margin-top: 6px; }
.home-weather { display: flex; gap: 16px; margin-top: 16px; }
.weather-item { display: flex; align-items: center; gap: 6px; font-size: 13px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QUICK ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.quick-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.quick-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 14px 8px; background: #FFFFFF; border: 1px solid rgba(46,125,50,.10); border-radius: var(--r); transition: .15s; box-shadow: 0 1px 6px rgba(46,125,50,.05); }
.quick-item:active { background: #F2F8F2; transform: scale(.97); }
.quick-icon { font-size: 24px; }
.quick-label { font-size: 11px; color: #5A7A5A; text-align: center; line-height: 1.3; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TASK STATUS CIRCLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.status-circle { display: inline-block; width: 8px; height: 8px; border-radius: 50%; }
.sc-green { background: var(--green); }
.sc-amber { background: var(--amber); }
.sc-red   { background: var(--red); }
.sc-blue  { background: var(--blue); }

/* responsive tweaks */
@media (max-width: 360px) { .stat-val { font-size: 18px; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WALLET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --orange:     #FF6F00;
  --orange-l:   #FF8F00;
  --orange-dim: rgba(255,111,0,.09);
  --orange-bg:  rgba(255,111,0,.06);
}
/* Balance hero */
.wallet-hero {
  background: linear-gradient(145deg, #1B5E20 0%, #2E7D32 55%, #388E3C 100%);
  padding: 28px 20px 32px; position: relative; overflow: hidden;
}
.wallet-hero::after {
  content:''; position:absolute; bottom:-40px; right:-40px;
  width:180px; height:180px; border-radius:50%;
  background: rgba(255,255,255,.05);
}
.wallet-hero::before {
  content:''; position:absolute; top:-30px; left:-20px;
  width:120px; height:120px; border-radius:50%;
  background: rgba(255,255,255,.04);
}
.wallet-balance-label { font-size:12px; color:rgba(255,255,255,.7); letter-spacing:.06em; }
.wallet-balance-amt {
  font-family: var(--mono); font-size: 40px; font-weight: 600; color: #FFFFFF;
  margin: 6px 0 20px; text-shadow: 0 2px 12px rgba(0,0,0,.15); position:relative;z-index:1;
}
/* Orange action button */
.btn-orange {
  background: linear-gradient(135deg, #FF6F00, #FF8F00);
  color: #FFFFFF; box-shadow: 0 4px 18px rgba(255,111,0,.4);
  border: none;
}
.btn-orange:active { background: #E65100; }
/* Transaction item */
.tx-item {
  display: flex; align-items: center; gap: 12px; padding: 13px 16px;
  border-bottom: 1px solid rgba(46,125,50,.07);
}
.tx-item:last-child { border-bottom: none; }
.tx-icon {
  width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 18px;
}
.tx-amt-pos { font-family:var(--mono); font-size:16px; font-weight:600; color:#2E7D32; }
.tx-amt-neg { font-family:var(--mono); font-size:16px; font-weight:600; color:#1B2E1B; }
/* Account card */
.acct-card {
  background: #FFFFFF; border: 1px solid rgba(46,125,50,.10); border-radius: 14px;
  padding: 14px 16px; display: flex; align-items: center; gap: 12px;
  margin-bottom: 10px; box-shadow: 0 2px 10px rgba(46,125,50,.05);
}
.acct-card-icon {
  width: 44px; height: 44px; border-radius: 12px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 22px;
}
/* Account type selector */
.acct-type-card {
  background: #FFFFFF; border: 2px solid rgba(46,125,50,.12); border-radius: 14px;
  padding: 16px 12px; text-align: center; cursor: pointer; transition: .15s;
}
.acct-type-card.selected { border-color: #FF6F00; background: rgba(255,111,0,.04); }
.acct-type-card:active { background: #F7FAF7; }
.acct-type-icon { font-size: 28px; margin-bottom: 6px; }
.acct-type-label { font-size: 12px; font-weight: 500; color: #1B2E1B; }
/* Withdrawal amount input */
.withdraw-input {
  font-family: var(--mono); font-size: 32px; font-weight: 600; color: #1B2E1B;
  border: none; outline: none; width: 100%; background: none; padding: 0;
}
.withdraw-input::placeholder { color: #C8E6C9; }
/* Step indicator */
.step-bar { display: flex; align-items: center; gap: 0; margin-bottom: 20px; }
.step-dot { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
.step-dot.active { background: #FF6F00; color: #FFFFFF; }
.step-dot.done { background: #2E7D32; color: #FFFFFF; }
.step-dot.pending { background: #EEF6EE; color: #9DB89C; border: 1.5px solid rgba(46,125,50,.15); }
.step-line { flex: 1; height: 2px; }
.step-line.done { background: #2E7D32; }
.step-line.pending { background: rgba(46,125,50,.15); }
/* Success screen */
.success-screen { display:flex; flex-direction:column; align-items:center; padding: 48px 24px; text-align:center; }
.success-circle { width: 80px; height: 80px; border-radius: 50%; background: rgba(46,125,50,.10); display:flex; align-items:center; justify-content:center; font-size:36px; margin-bottom:20px; }

.fl-type-btn {
  display: inline-flex; align-items: center; gap: 5px; padding: 7px 14px;
  border-radius: 20px; font-size: 12px; font-weight: 500; border: 1.5px solid rgba(46,125,50,.18);
  background: #FFFFFF; color: #5A7A5A; cursor: pointer; white-space: nowrap; transition: .15s;
  font-family: var(--sans);
}
.fl-type-btn.active { background: #2E7D32; color: #FFFFFF; border-color: #2E7D32; }
.fl-type-btn:active { opacity: .8; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FARMLOG CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fl-card {
  background: #FFFFFF; border: 1px solid rgba(46,125,50,.10); border-radius: 14px;
  margin-bottom: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(46,125,50,.05);
  cursor: pointer; transition: .15s;
}
.fl-card:active { background: #F7FAF7; }
.fl-card-hd {
  padding: 12px 14px; display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid rgba(46,125,50,.07);
}
.fl-type-tag {
  padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;
}
.fl-card-body { padding: 12px 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FARMLOG DETAIL SECTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fl-section { background: #FFFFFF; border-radius: 14px; margin: 0 0 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(46,125,50,.05); }
.fl-section-title {
  padding: 12px 16px; font-size: 12px; font-weight: 600; letter-spacing: .05em;
  text-transform: uppercase; color: #5A7A5A; background: #F7FAF7;
  border-bottom: 1px solid rgba(46,125,50,.08);
}
.fl-section-body { padding: 14px 16px; }
.fl-row { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 10px; }
.fl-row:last-child { margin-bottom: 0; }
.fl-row-label { font-size: 12px; color: #9DB89C; width: 64px; flex-shrink: 0; margin-top: 1px; }
.fl-row-val { font-size: 13px; color: #1B2E1B; flex: 1; line-height: 1.5; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OBSERVATION CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.obs-card {
  background: #F7FAF7; border: 1px solid rgba(46,125,50,.12); border-radius: 10px;
  padding: 12px; position: relative; margin-bottom: 10px;
}
.obs-card-del {
  position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
  border-radius: 50%; background: rgba(198,40,40,.1); color: #C62828;
  display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer;
}
.obs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
.obs-field { display: flex; flex-direction: column; gap: 3px; }
.obs-field label { font-size: 10px; color: #9DB89C; }
.obs-field input {
  background: #FFFFFF; border: 1px solid rgba(46,125,50,.2); border-radius: 8px;
  padding: 7px 10px; font-size: 13px; color: #1B2E1B; width: 100%; font-family: var(--sans);
}
.obs-field input:focus { outline: none; border-color: #2E7D32; }
.obs-field select {
  background: #FFFFFF; border: 1px solid rgba(46,125,50,.2); border-radius: 8px;
  padding: 7px 10px; font-size: 13px; color: #1B2E1B; width: 100%; font-family: var(--sans);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PHOTO UPLOAD AREA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.photo-slot {
  aspect-ratio: 1; border: 2px dashed rgba(46,125,50,.25); border-radius: 10px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: #F7FAF7; cursor: pointer; color: #9DB89C; font-size: 12px; gap: 4px;
  transition: .15s;
}
.photo-slot:active { background: #EEF6EE; }
.photo-slot span { font-size: 24px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD ROW BUTTON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.add-row-btn {
  width: 100%; padding: 10px; border: 1.5px dashed rgba(46,125,50,.3);
  border-radius: 10px; color: #2E7D32; font-size: 13px; font-weight: 500;
  background: rgba(46,125,50,.04); cursor: pointer; font-family: var(--sans);
  transition: .15s; display: flex; align-items: center; justify-content: center; gap: 6px;
}
.add-row-btn:active { background: rgba(46,125,50,.10); }

/* Photo scroll in detail */
.photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; }
.photo-scroll::-webkit-scrollbar { display: none; }
.photo-thumb {
  width: 90px; height: 90px; border-radius: 10px; background: #EEF6EE;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  font-size: 28px; cursor: pointer; border: 1px solid rgba(46,125,50,.12);
}

/* Severity radio */
.severity-group { display: flex; gap: 8px; }
.sev-btn {
  flex: 1; padding: 8px; border: 1.5px solid rgba(46,125,50,.2); border-radius: 8px;
  text-align: center; font-size: 13px; cursor: pointer; background: #FFFFFF;
  font-family: var(--sans); transition: .15s;
}
.sev-btn.active-light  { background: rgba(46,125,50,.08); border-color: #43A047; color: #2E7D32; }
.sev-btn.active-medium { background: rgba(230,81,0,.08); border-color: #E65100; color: #E65100; }
.sev-btn.active-heavy  { background: rgba(198,40,40,.08); border-color: #C62828; color: #C62828; }

/* Field validation error */
.field-err { border-color: #C62828 !important; }
.field-err-msg { font-size: 11px; color: #C62828; margin-top: 3px; }
</style>
</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-login">
  <div class="login-bg"></div>
  <div class="login-art">
    <div>
      <div class="login-logo" style="text-align:center;font-size:72px">ğŸŒ¾</div>
      <div class="login-brand">
        <div class="login-brand-name" style="letter-spacing:.12em;color:#2E7D32">æ™ºå†œäº‘</div>
        <div class="login-brand-sub">Smart Agriculture Platform</div>
      </div>
    </div>
  </div>
  <div class="login-form">
    <div class="login-tab" id="login-tab">
      <button class="active" onclick="switchLoginTab('login')">ç™»å½•</button>
      <button onclick="switchLoginTab('register')">æ³¨å†Œ</button>
    </div>
    <div id="login-fields" style="display:flex;flex-direction:column;gap:12px">
      <div class="field">
        <span>ğŸ“±</span>
        <input type="tel" id="login-phone" placeholder="æ‰‹æœºå·" maxlength="11" value="13800138000">
      </div>
      <div class="field">
        <span>ğŸ”’</span>
        <input type="password" id="login-pass" placeholder="å¯†ç " value="123456">
      </div>
      <button class="btn btn-primary btn-full" style="margin-top:8px;height:48px;font-size:16px;border-radius:var(--r)" onclick="doLogin()">ç™» å½•</button>
      <div style="text-align:center;font-size:12px;color:#9DB89C;margin-top:4px">æ¼”ç¤ºè´¦å·å·²å¡«å…¥ï¼Œç›´æ¥ç‚¹å‡»ç™»å½•</div>
    </div>
    <div id="register-fields" style="display:none;flex-direction:column;gap:12px">
      <div class="field"><span>ğŸ“±</span><input type="tel" placeholder="æ‰‹æœºå·" maxlength="11"></div>
      <div class="field"><span>ğŸ’¬</span><input type="text" placeholder="éªŒè¯ç " maxlength="6"><button style="color:#2E7D32;font-size:13px;white-space:nowrap" onclick="toast('éªŒè¯ç å·²å‘é€')">è·å–éªŒè¯ç </button></div>
      <div class="field"><span>ğŸ¢</span><input type="text" placeholder="å§“å/ä¼ä¸šåç§°"></div>
      <div class="field"><span>ğŸ”’</span><input type="password" placeholder="è®¾ç½®å¯†ç "></div>
      <button class="btn btn-primary btn-full" style="margin-top:8px;height:48px;font-size:16px;border-radius:var(--r)" onclick="toast('æ³¨å†ŒåŠŸèƒ½æ¼”ç¤ºä¸­')">æ³¨ å†Œ</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-home">
  <div class="page-body">
    <div class="home-hero">
      <div class="home-greeting">æ—©ä¸Šå¥½</div>
      <div class="home-name" id="home-username">ç‹å¤§æ˜</div>
      <div class="home-date" id="home-date">--</div>
      <div class="home-weather">
        <div class="weather-item">â˜€ï¸ <span>æ™´, 26Â°C</span></div>
        <div class="weather-item">ğŸ’¨ <span>å¾®é£ 3m/s</span></div>
        <div class="weather-item">ğŸ’§ <span>æ¹¿åº¦ 68%</span></div>
      </div>
    </div>

    <!-- å¿«æ·å…¥å£ -->
    <div class="sec">
      <div class="sec-hd"><span class="sec-title">å¿«æ·å…¥å£</span></div>
      <div class="quick-grid">
        <div class="quick-item" onclick="nav('fields')">
          <span class="quick-icon">ğŸ—ºï¸</span><span class="quick-label">åœ°å—ç®¡ç†</span>
        </div>
        <div class="quick-item" onclick="nav('drone')">
          <span class="quick-icon">ğŸš</span><span class="quick-label">æ— äººæœºä»»åŠ¡</span>
        </div>
        <div class="quick-item" onclick="nav('ndvi')">
          <span class="quick-icon">ğŸŒ¿</span><span class="quick-label">NDVIåˆ†æ</span>
        </div>
        <div class="quick-item" onclick="nav('alerts')">
          <span class="quick-icon">ğŸ””</span>
          <span class="quick-label" style="position:relative">é¢„è­¦æ¶ˆæ¯<span style="position:absolute;top:-4px;right:-6px;background:var(--red);color:#FFFFFF;font-size:9px;width:15px;height:15px;border-radius:50%;display:flex;align-items:center;justify-content:center">3</span></span>
        </div>
        <div class="quick-item" onclick="showIrrigation()">
          <span class="quick-icon">ğŸ’§</span><span class="quick-label">çŒæº‰æ§åˆ¶</span>
        </div>
        <div class="quick-item" onclick="nav('farmlog')">
          <span class="quick-icon">ğŸ“‹</span><span class="quick-label">å†œäº‹è®°å½•</span>
        </div>
        <div class="quick-item" onclick="toast('å‘˜å·¥ç®¡ç†åŠŸèƒ½')">
          <span class="quick-icon">ğŸ‘¥</span><span class="quick-label">å‘˜å·¥ç®¡ç†</span>
        </div>
        <div class="quick-item" onclick="toast('æ•°æ®æŠ¥å‘ŠåŠŸèƒ½')">
          <span class="quick-icon">ğŸ“Š</span><span class="quick-label">æ•°æ®æŠ¥å‘Š</span>
        </div>
      </div>
    </div>

    <!-- æ€»è§ˆæ•°æ® -->
    <div class="sec">
      <div class="sec-hd"><span class="sec-title">å†œåœºæ¦‚è§ˆ</span></div>
      <div class="stat-grid">
        <div class="stat-box fade-up">
          <div class="stat-val" style="color:#2E7D32" id="stat-area">--</div>
          <div class="stat-label">ç®¡ç†æ€»é¢ç§¯ï¼ˆäº©ï¼‰</div>
          <div class="stat-trend" style="color:#2E7D32">â†‘ 12% åŒæ¯”å¢é•¿</div>
        </div>
        <div class="stat-box fade-up">
          <div class="stat-val" style="color:#1565C0" id="stat-fields">--</div>
          <div class="stat-label">åœ°å—æ•°é‡</div>
          <div class="stat-trend" style="color:#5A7A5A">æ´»è·ƒ 6 å—</div>
        </div>
        <div class="stat-box fade-up">
          <div class="stat-val" style="color:#E65100;cursor:pointer" id="stat-flights" onclick="nav('farmlog')">--</div>
          <div class="stat-label">å†œäº‹è®°å½•ï¼ˆæ¡ï¼‰</div>
          <div class="stat-trend" style="color:#5A7A5A">ç‚¹å‡»æŸ¥çœ‹</div>
          <div class="stat-trend" style="color:#E65100">â†‘ 5 æ¬¡</div>
        </div>
        <div class="stat-box fade-up">
          <div class="stat-val" style="color:#C62828" id="stat-alerts">--</div>
          <div class="stat-label">å¾…å¤„ç†é¢„è­¦</div>
          <div class="stat-trend" style="color:#C62828">â— éœ€ç«‹å³å¤„ç†</div>
        </div>
      </div>
    </div>

    <!-- æœ€è¿‘å†œäº‹è®°å½• -->
    <div class="sec">
      <div class="sec-hd">
        <span class="sec-title">æœ€è¿‘å†œäº‹è®°å½•</span>
        <span class="sec-more" onclick="nav('farmlog')">æŸ¥çœ‹å…¨éƒ¨ â€º</span>
      </div>
      <div id="recent-farmlogs"></div>
    </div>

    <!-- æœ€è¿‘ä»»åŠ¡ -->
    <div class="sec">
      <div class="sec-hd">
        <span class="sec-title">æœ€è¿‘é£è¡Œä»»åŠ¡</span>
        <span class="sec-more" onclick="nav('drone')">æŸ¥çœ‹å…¨éƒ¨ â€º</span>
      </div>
      <div class="card" id="recent-tasks"></div>
    </div>

    <!-- æœ€æ–°é¢„è­¦ -->
    <div class="sec">
      <div class="sec-hd">
        <span class="sec-title">æœ€æ–°é¢„è­¦</span>
        <span class="sec-more" onclick="nav('alerts')">æŸ¥çœ‹å…¨éƒ¨ â€º</span>
      </div>
      <div id="recent-alerts"></div>
    </div>

    <div style="height:20px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: FIELDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-fields">
  <div class="hdr">
    <div class="hdr-title">åœ°å—ç®¡ç†</div>
    <button class="hdr-action" onclick="showAddField()">â•</button>
  </div>
  <div class="page-body">
    <!-- åœ°å›¾åŒºåŸŸ -->
    <div style="padding:12px 16px 0">
      <div class="map-box" style="height:200px" id="field-map">
        <svg width="100%" height="100%" viewBox="0 0 340 200">
          <!-- æ¨¡æ‹Ÿå«æ˜Ÿåœ°å›¾åœ°å— -->
          <polygon points="30,40 120,25 180,60 160,110 60,120" fill="rgba(46,125,50,.12)" stroke="#2E7D32" stroke-width="1.5"/>
          <polygon points="190,30 280,20 310,70 270,90 195,75" fill="rgba(21,101,192,.10)" stroke="#1565C0" stroke-width="1.5"/>
          <polygon points="80,135 180,125 200,175 90,180" fill="rgba(230,81,0,.10)" stroke="#E65100" stroke-width="1.5"/>
          <polygon points="215,100 290,95 305,155 220,160" fill="rgba(51,105,30,.10)" stroke="#33691E" stroke-width="1.5"/>
          <!-- åœ°å—æ ‡ç­¾ -->
          <text x="90" y="80" fill="#1B5E20" font-size="10" font-family="Noto Sans SC">AåŒº Â· å°éº¦</text>
          <text x="230" y="58" fill="#1565C0" font-size="10" font-family="Noto Sans SC">BåŒº Â· æ°´ç¨»</text>
          <text x="120" y="160" fill="#E65100" font-size="10" font-family="Noto Sans SC">CåŒº Â· ç‰ç±³</text>
          <text x="235" y="135" fill="#33691E" font-size="10" font-family="Noto Sans SC">DåŒº Â· å¤§è±†</text>
          <!-- æ¯”ä¾‹å°º -->
          <line x1="15" y1="185" x2="65" y2="185" stroke="#C8E6C9" stroke-width="1"/>
          <text x="25" y="193" fill="#9DB89C" font-size="9">200m</text>
        </svg>
        <div style="position:absolute;bottom:8px;right:8px;display:flex;gap:6px">
          <button class="btn btn-ghost" style="padding:4px 10px;font-size:11px" onclick="toast('å«æ˜Ÿå›¾åˆ‡æ¢')">å«æ˜Ÿå›¾</button>
          <button class="btn btn-ghost" style="padding:4px 10px;font-size:11px" onclick="toast('å…¨å±æŸ¥çœ‹')">â›¶</button>
        </div>
      </div>
    </div>

    <!-- åœ°å—åˆ—è¡¨ -->
    <div class="sec" style="margin-top:16px">
      <div class="sec-hd"><span class="sec-title">åœ°å—åˆ—è¡¨</span><span style="font-size:12px;color:#5A7A5A" id="field-count">å…± 0 å—</span></div>
      <div class="card" id="field-list"></div>
    </div>

    <div style="height:16px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: DRONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-drone">
  <div class="hdr">
    <div class="hdr-title">M3M æ— äººæœºä»»åŠ¡</div>
    <button class="hdr-action" style="font-size:20px" onclick="showCreateTask()">â•</button>
  </div>
  <div class="page-body">

    <!-- è®¾å¤‡çŠ¶æ€å¡ -->
    <div style="padding:12px 16px 0">
      <div class="card card-p" id="drone-status-card">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:40px">ğŸš</div>
          <div style="flex:1">
            <div style="font-size:15px;font-weight:600">Mavic 3 Multispectral</div>
            <div style="font-size:12px;color:#5A7A5A;margin-top:2px;font-family:var(--mono)">SN: DJI-M3M-A8F2C1</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <span class="badge badge-green" id="drone-conn-badge">â— å·²è¿æ¥</span>
              <span class="badge badge-blue">MSDK 5</span>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-family:var(--mono);font-size:24px;font-weight:500;color:#2E7D32" id="drone-batt">82%</div>
            <div style="font-size:11px;color:#5A7A5A">ç”µé‡</div>
          </div>
        </div>
        <!-- å®æ—¶é¥æµ‹ -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid rgba(46,125,50,.09)">
          <div style="text-align:center">
            <div style="font-family:var(--mono);font-size:15px;color:#1565C0" id="tele-alt">--</div>
            <div style="font-size:10px;color:#9DB89C">é«˜åº¦(m)</div>
          </div>
          <div style="text-align:center">
            <div style="font-family:var(--mono);font-size:15px;color:#E65100" id="tele-spd">--</div>
            <div style="font-size:10px;color:#9DB89C">é€Ÿåº¦(m/s)</div>
          </div>
          <div style="text-align:center">
            <div style="font-family:var(--mono);font-size:15px;color:#2E7D32" id="tele-dist">--</div>
            <div style="font-size:10px;color:#9DB89C">è·ç¦»(m)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»»åŠ¡ç­›é€‰ -->
    <div style="padding:14px 16px 0;display:flex;gap:8px;overflow-x:auto">
      <div class="chip active" id="chip-all" onclick="filterTasks('all',this)">å…¨éƒ¨</div>
      <div class="chip" id="chip-flying" onclick="filterTasks('flying',this)">é£è¡Œä¸­</div>
      <div class="chip" id="chip-pending" onclick="filterTasks('pending',this)">å¾…æ‰§è¡Œ</div>
      <div class="chip" id="chip-done" onclick="filterTasks('done',this)">å·²å®Œæˆ</div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <div class="sec">
      <div class="card" id="task-list"></div>
    </div>

    <div style="height:16px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: LIVE TRACKING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-tracking">
  <div class="hdr">
    <button class="hdr-back" onclick="back()">â€¹</button>
    <div class="hdr-title" id="tracking-title">å®æ—¶è½¨è¿¹</div>
    <div class="hdr-action"></div>
  </div>
  <div class="page-body" style="padding-bottom:20px">
    <div style="padding:12px 16px 0">
      <!-- å®æ—¶è½¨è¿¹åœ°å›¾ -->
      <div class="drone-track" id="tracking-map">
        <svg class="drone-path" viewBox="0 0 320 240" id="track-svg"></svg>
        <div class="drone-icon" id="drone-icon">ğŸš</div>
        <div style="position:absolute;top:10px;left:10px;background:rgba(255,255,255,.92);border:1px solid rgba(46,125,50,.14);border-radius:8px;padding:6px 10px">
          <div style="font-size:10px;color:#5A7A5A">å®æ—¶ä½ç½®</div>
          <div style="font-family:var(--mono);font-size:10px;color:#2E7D32" id="track-pos">120.4523Â°E  30.7821Â°N</div>
        </div>
        <div style="position:absolute;bottom:10px;right:10px;display:flex;gap:6px">
          <div class="badge badge-green"><span class="pulse" style="width:6px;height:6px"></span> ç›´æ’­ä¸­</div>
        </div>
      </div>
    </div>

    <!-- å®æ—¶æ•°æ® -->
    <div style="padding:12px 16px 0">
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px" id="telemetry-grid">
        <div class="stat-box">
          <div style="font-size:10px;color:#5A7A5A;margin-bottom:6px">ğŸ“ é£è¡Œé«˜åº¦</div>
          <div class="stat-val" style="color:#1565C0" id="rt-alt">90.0 m</div>
        </div>
        <div class="stat-box">
          <div style="font-size:10px;color:#5A7A5A;margin-bottom:6px">âš¡ é£è¡Œé€Ÿåº¦</div>
          <div class="stat-val" style="color:#E65100" id="rt-spd">8.4 m/s</div>
        </div>
        <div class="stat-box">
          <div style="font-size:10px;color:#5A7A5A;margin-bottom:6px">ğŸ”‹ ç”µé‡å‰©ä½™</div>
          <div class="stat-val" id="rt-batt" style="color:#2E7D32">78%</div>
          <div class="prog-wrap" style="margin-top:8px"><div class="prog-fill" id="rt-batt-bar" style="width:78%"></div></div>
        </div>
        <div class="stat-box">
          <div style="font-size:10px;color:#5A7A5A;margin-bottom:6px">ğŸ“¸ å·²æ‹å¼ æ•°</div>
          <div class="stat-val" style="color:#2E7D32" id="rt-photos">0</div>
        </div>
        <div class="stat-box">
          <div style="font-size:10px;color:#5A7A5A;margin-bottom:6px">âœ… å®Œæˆè¿›åº¦</div>
          <div class="stat-val" id="rt-progress">0%</div>
          <div class="prog-wrap" style="margin-top:8px"><div class="prog-fill" id="rt-prog-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-box">
          <div style="font-size:10px;color:#5A7A5A;margin-bottom:6px">â± é£è¡Œæ—¶é•¿</div>
          <div class="stat-val" style="color:#5A7A5A;font-family:var(--mono);font-size:18px" id="rt-time">00:00</div>
        </div>
      </div>
    </div>

    <!-- å¤šå…‰è°±æ•°æ®å®æ—¶é¢„è§ˆ -->
    <div class="sec">
      <div class="sec-hd"><span class="sec-title">å¤šå…‰è°±å®æ—¶æ•°æ®</span></div>
      <div class="card card-p">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
          <div style="text-align:center">
            <div style="width:36px;height:36px;background:rgba(0,255,148,.25);border-radius:8px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸŸ©</div>
            <div style="font-family:var(--mono);font-size:13px;color:#00FF94" id="ms-g">0.72</div>
            <div style="font-size:10px;color:#9DB89C">Green</div>
          </div>
          <div style="text-align:center">
            <div style="width:36px;height:36px;background:rgba(198,40,40,.10);border-radius:8px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸŸ¥</div>
            <div style="font-family:var(--mono);font-size:13px;color:#C62828" id="ms-r">0.38</div>
            <div style="font-size:10px;color:#9DB89C">Red</div>
          </div>
          <div style="text-align:center">
            <div style="width:36px;height:36px;background:rgba(230,81,0,.10);border-radius:8px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸŸ§</div>
            <div style="font-family:var(--mono);font-size:13px;color:#E65100" id="ms-re">0.55</div>
            <div style="font-size:10px;color:#9DB89C">Red Edge</div>
          </div>
          <div style="text-align:center">
            <div style="width:36px;height:36px;background:rgba(21,101,192,.10);border-radius:8px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸŸ¦</div>
            <div style="font-family:var(--mono);font-size:13px;color:#1565C0" id="ms-nir">0.84</div>
            <div style="font-size:10px;color:#9DB89C">NIR</div>
          </div>
        </div>
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(46,125,50,.09)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;color:#5A7A5A">å®æ—¶ NDVI</span>
            <span class="badge badge-green" id="rt-ndvi-badge">å¥åº·</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="ndvi-bar" style="flex:1;position:relative">
              <div class="ndvi-pointer" id="ndvi-pointer" style="left:60%"></div>
            </div>
            <div style="font-family:var(--mono);font-size:18px;font-weight:500;color:#2E7D32" id="rt-ndvi">0.61</div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:10px;color:#9DB89C">
            <span>-1 (è£¸åœŸ)</span><span>0</span><span>+1 (èŒ‚ç››)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»»åŠ¡æ§åˆ¶ -->
    <div class="sec">
      <div style="display:flex;gap:10px">
        <button class="btn btn-danger" style="flex:1;height:48px" onclick="pauseTask()">â¸ æš‚åœ</button>
        <button class="btn btn-ghost" style="flex:1;height:48px" onclick="returnHome()">ğŸ  è¿”èˆª</button>
        <button class="btn btn-primary" style="flex:1;height:48px;background:var(--red);color:#FFFFFF" onclick="emergencyStop()">ğŸš¨ ç´§æ€¥åœ</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: NDVI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-ndvi">
  <div class="hdr">
    <div class="hdr-title">NDVI æ¤è¢«åˆ†æ</div>
    <button class="hdr-action" onclick="toast('å¯¼å‡ºæŠ¥å‘Š')">ğŸ“¤</button>
  </div>
  <div class="page-body">
    <!-- åœ°å—é€‰æ‹© -->
    <div style="padding:12px 16px 0;display:flex;gap:8px;overflow-x:auto">
      <div class="chip active" onclick="selectNdviField('A',this)">AåŒº Â· å°éº¦</div>
      <div class="chip" onclick="selectNdviField('B',this)">BåŒº Â· æ°´ç¨»</div>
      <div class="chip" onclick="selectNdviField('C',this)">CåŒº Â· ç‰ç±³</div>
      <div class="chip" onclick="selectNdviField('D',this)">DåŒº Â· å¤§è±†</div>
    </div>

    <!-- NDVI åœ°å›¾ -->
    <div style="padding:12px 16px 0">
      <div class="map-box" style="height:200px">
        <svg width="100%" height="100%" viewBox="0 0 340 200" id="ndvi-map-svg">
          <!-- NDVIä¼ªå½©è‰²åœ°å›¾ -->
          <defs>
            <radialGradient id="ng1" cx="40%" cy="45%"><stop offset="0%" stop-color="#2E7D32" stop-opacity=".8"/><stop offset="60%" stop-color="#66BB6A" stop-opacity=".6"/><stop offset="100%" stop-color="#F9A825" stop-opacity=".3"/></radialGradient>
            <radialGradient id="ng2" cx="60%" cy="50%"><stop offset="0%" stop-color="#43A047" stop-opacity=".8"/><stop offset="80%" stop-color="#AED581" stop-opacity=".4"/></radialGradient>
            <radialGradient id="ng3" cx="30%" cy="60%"><stop offset="0%" stop-color="#C62828" stop-opacity=".7"/><stop offset="70%" stop-color="#F9A825" stop-opacity=".5"/></radialGradient>
          </defs>
          <polygon points="20,20 160,10 200,90 170,140 30,135" fill="url(#ng1)"/>
          <ellipse cx="130" cy="70" rx="50" ry="40" fill="url(#ng2)" opacity=".6"/>
          <ellipse cx="80" cy="100" rx="30" ry="25" fill="url(#ng3)" opacity=".6"/>
          <!-- è‰²é˜¶å›¾ä¾‹ -->
          <rect x="230" y="150" width="100" height="12" rx="3" fill="url(#ndvi-legend-grad)"/>
          <defs><linearGradient id="ndvi-legend-grad"><stop offset="0%" stop-color="#C62828"/><stop offset="25%" stop-color="#E65100"/><stop offset="50%" stop-color="#F9A825"/><stop offset="75%" stop-color="#66BB6A"/><stop offset="100%" stop-color="#2E7D32"/></linearGradient></defs>
          <text x="228" y="175" fill="#9DB89C" font-size="8">-1</text>
          <text x="326" y="175" fill="#9DB89C" font-size="8">+1</text>
          <text x="265" y="145" fill="#1B2E1B" font-size="9">NDVI</text>
        </svg>
        <div style="position:absolute;top:8px;right:8px">
          <span class="badge badge-green" style="font-size:10px">2024-01-15 é‡‡é›†</span>
        </div>
      </div>
    </div>

    <!-- NDVI æ±‡æ€» -->
    <div class="sec">
      <div class="card card-p" id="ndvi-summary">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
          <div>
            <div style="font-family:var(--mono);font-size:22px;font-weight:500;color:#2E7D32" id="ndvi-avg">0.68</div>
            <div style="font-size:11px;color:#5A7A5A;margin-top:3px">å¹³å‡ NDVI</div>
          </div>
          <div>
            <div style="font-family:var(--mono);font-size:22px;font-weight:500;color:#43A047" id="ndvi-max">0.89</div>
            <div style="font-size:11px;color:#5A7A5A;margin-top:3px">æœ€é«˜å€¼</div>
          </div>
          <div>
            <div style="font-family:var(--mono);font-size:22px;font-weight:500;color:#E65100" id="ndvi-min">0.21</div>
            <div style="font-size:11px;color:#5A7A5A;margin-top:3px">æœ€ä½å€¼</div>
          </div>
        </div>
        <div style="margin-top:16px;padding-top:14px;border-top:1px solid rgba(46,125,50,.09)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <span style="font-size:12px;color:#5A7A5A">å¥åº·çŠ¶å†µåˆ†å¸ƒ</span>
          </div>
          <div id="health-bars"></div>
        </div>
      </div>
    </div>

    <!-- æ³¢æ®µæ•°æ® -->
    <div class="sec">
      <div class="sec-hd"><span class="sec-title">å¤šå…‰è°±æ³¢æ®µåå°„ç‡</span></div>
      <div class="card card-p">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0" id="band-bars"></div>
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(46,125,50,.09);font-size:12px;color:#5A7A5A;line-height:1.8" id="ndvi-insight"></div>
      </div>
    </div>

    <!-- å†å²è¶‹åŠ¿ -->
    <div class="sec">
      <div class="sec-hd"><span class="sec-title">NDVI å†å²è¶‹åŠ¿</span></div>
      <div class="card card-p">
        <svg width="100%" height="120" viewBox="0 0 300 120" id="ndvi-trend-svg">
          <defs><linearGradient id="trendFill" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#2E7D32" stop-opacity=".15"/><stop offset="100%" stop-color="#2E7D32" stop-opacity="0"/></linearGradient></defs>
          <polygon points="0,95 50,85 100,70 150,60 200,45 250,55 300,40 300,120 0,120" fill="url(#trendFill)"/>
          <polyline points="0,95 50,85 100,70 150,60 200,45 250,55 300,40" fill="none" stroke="rgba(46,125,50,.2)" stroke-width="1.5"/>
          <polyline points="0,95 50,85 100,70 150,60 200,45 250,55 300,40" fill="none" stroke="#2E7D32" stroke-width="2"/>
          <circle cx="0"   cy="95" r="3" fill="#2E7D32"/>
          <circle cx="50"  cy="85" r="3" fill="#2E7D32"/>
          <circle cx="100" cy="70" r="3" fill="#2E7D32"/>
          <circle cx="150" cy="60" r="3" fill="#2E7D32"/>
          <circle cx="200" cy="45" r="3" fill="#2E7D32"/>
          <circle cx="250" cy="55" r="3" fill="#E65100"/>
          <circle cx="300" cy="40" r="5" fill="#43A047" stroke="#FFFFFF" stroke-width="2"/>
          <line x1="0" y1="80" x2="300" y2="80" stroke="rgba(46,125,50,.15)" stroke-width="1" stroke-dasharray="4 4"/>
          <text x="4" y="78" fill="#9DB89C" font-size="8">0.5</text>
          <text x="0"   y="115" fill="#9DB89C" font-size="8">10æœˆ</text>
          <text x="60"  y="115" fill="#9DB89C" font-size="8">11æœˆ</text>
          <text x="120" y="115" fill="#9DB89C" font-size="8">12æœˆ</text>
          <text x="180" y="115" fill="#9DB89C" font-size="8">1æœˆ</text>
          <text x="265" y="115" fill="#9DB89C" font-size="8">å½“å‰</text>
        </svg>
      </div>
    </div>

    <!-- å¤„æ–¹å›¾ -->
    <div class="sec">
      <div class="sec-hd"><span class="sec-title">æ™ºèƒ½å¤„æ–¹å›¾å»ºè®®</span></div>
      <div class="card card-p" style="display:flex;flex-direction:column;gap:10px" id="prescription"></div>
    </div>

    <div style="height:16px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: ALERTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-alerts">
  <div class="hdr">
    <div class="hdr-title">æ¶ˆæ¯ Â· é¢„è­¦ Â· å¾…åŠ</div>
    <button class="hdr-action" onclick="markAllRead()" style="font-size:12px;color:#2E7D32">å…¨è¯»</button>
  </div>
  <div class="page-body">
    <div style="padding:12px 16px 0;display:flex;gap:8px">
      <div class="chip active" onclick="switchAlertTab('all',this)">å…¨éƒ¨</div>
      <div class="chip" onclick="switchAlertTab('warn',this)">é¢„è­¦</div>
      <div class="chip" onclick="switchAlertTab('todo',this)">å¾…åŠ</div>
      <div class="chip" onclick="switchAlertTab('msg',this)">æ¶ˆæ¯</div>
    </div>

    <div class="sec" id="alert-list"></div>

    <div style="height:16px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: PROFILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-profile">
  <div class="page-body">
    <div style="padding:32px 20px 20px;background:linear-gradient(150deg,#E8F5E9 0%,#F1F8E9 100%);border-bottom:1px solid rgba(46,125,50,.12)">
      <div style="display:flex;align-items:center;gap:16px">
        <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#2E7D32,#66BB6A);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;box-shadow:0 4px 16px rgba(46,125,50,.25)">ğŸ‘¨â€ğŸŒ¾</div>
        <div>
          <div style="font-size:20px;font-weight:700">ç‹å¤§æ˜</div>
          <div style="font-size:12px;color:#5A7A5A;margin-top:3px">å†œæˆ·ç«¯ Â· å¤§æ€»ç®¡</div>
          <div style="font-family:var(--mono);font-size:11px;color:#9DB89C;margin-top:4px">138 0013 8000</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);margin-top:20px;text-align:center;padding-top:16px;border-top:1px solid rgba(46,125,50,.09)">
        <div><div style="font-family:var(--mono);font-size:18px;font-weight:500;color:#2E7D32">1280</div><div style="font-size:11px;color:#5A7A5A">ç®¡ç†é¢ç§¯</div></div>
        <div style="border-left:1px solid rgba(46,125,50,.09);border-right:1px solid rgba(46,125,50,.09)"><div style="font-family:var(--mono);font-size:18px;font-weight:500;color:#1565C0">8</div><div style="font-size:11px;color:#5A7A5A">åœ°å—æ•°</div></div>
        <div><div style="font-family:var(--mono);font-size:18px;font-weight:500;color:#E65100">24</div><div style="font-size:11px;color:#5A7A5A">é£è¡Œæ¶æ¬¡</div></div>
      </div>
    </div>

    <div class="sec">
      <div class="card">
        <div class="list-row" onclick="navWallet()"><div class="list-icon" style="background:rgba(255,111,0,.10)">ğŸ’°</div><div class="list-body"><div class="list-title">æˆ‘çš„é’±åŒ…</div><div class="list-sub" id="profile-balance">ä½™é¢ Â¥5,800.00</div></div><span style="color:#9DB89C">â€º</span></div>
        <div class="list-row" onclick="toast('è´¦æˆ·ä¿¡æ¯')"><div class="list-icon" style="background:var(--green-dim)">ğŸ‘¤</div><div class="list-body"><div class="list-title">è´¦æˆ·ä¿¡æ¯</div><div class="list-sub">æŸ¥çœ‹å’Œä¿®æ”¹ä¸ªäººèµ„æ–™</div></div><span style="color:#9DB89C">â€º</span></div>
        <div class="list-row" onclick="toast('è®¤è¯ç®¡ç†')"><div class="list-icon" style="background:var(--blue-dim)">ğŸ“‹</div><div class="list-body"><div class="list-title">å®åè®¤è¯</div><div class="list-sub">å·²é€šè¿‡è®¤è¯</div></div><span class="badge badge-green" style="font-size:11px">âœ“</span></div>
        <div class="list-row" onclick="toast('M3Mè®¾å¤‡')"><div class="list-icon" style="background:var(--amber-dim)">ğŸš</div><div class="list-body"><div class="list-title">æˆ‘çš„è®¾å¤‡</div><div class="list-sub">M3M Â· åœ¨çº¿ 1 å°</div></div><span style="color:#9DB89C">â€º</span></div>
        <div class="list-row" onclick="toast('æ¶ˆæ¯è®¾ç½®')"><div class="list-icon" style="background:var(--card2)">ğŸ””</div><div class="list-body"><div class="list-title">æ¶ˆæ¯é€šçŸ¥</div><div class="list-sub">æ¨é€ã€çŸ­ä¿¡æé†’</div></div><span style="color:#9DB89C">â€º</span></div>
      </div>
    </div>

    <div class="sec">
      <div class="card">
        <div class="list-row" onclick="toast('å¸®åŠ©æ–‡æ¡£')"><div class="list-icon" style="background:var(--card2)">ğŸ“–</div><div class="list-body"><div class="list-title">å¸®åŠ©ä¸æ”¯æŒ</div><div class="list-sub">æ“ä½œæ‰‹å†Œã€å¸¸è§é—®é¢˜</div></div><span style="color:#9DB89C">â€º</span></div>
        <div class="list-row" onclick="toast('å…³äºå¹³å°')"><div class="list-icon" style="background:var(--card2)">â„¹ï¸</div><div class="list-body"><div class="list-title">å…³äºæ™ºå†œäº‘</div><div class="list-sub">ç‰ˆæœ¬ v1.0.0</div></div><span style="color:#9DB89C">â€º</span></div>
        <div class="list-row" onclick="doLogout()" style="cursor:pointer"><div class="list-icon" style="background:var(--red-dim)">ğŸšª</div><div class="list-body"><div class="list-title" style="color:#C62828">é€€å‡ºç™»å½•</div></div></div>
      </div>
    </div>
    <div style="height:16px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: WALLET HOME  5.3.1.1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-wallet">
  <div class="hdr" style="background:#2E7D32;border-bottom:none">
    <button class="hdr-back" onclick="back()" style="color:#FFFFFF;background:rgba(255,255,255,.15)">â€¹</button>
    <div class="hdr-title" style="color:#FFFFFF">æˆ‘çš„é’±åŒ…</div>
    <div class="hdr-action"></div>
  </div>
  <div class="page-body" style="padding-bottom:24px">
    <!-- ä½™é¢å¡ç‰‡ -->
    <div class="wallet-hero">
      <div class="wallet-balance-label">è´¦æˆ·æ€»ä½™é¢ï¼ˆå…ƒï¼‰</div>
      <div class="wallet-balance-amt" id="wallet-balance-amt">5,800.00</div>
      <button class="btn btn-orange" style="height:42px;padding:0 32px;border-radius:10px;font-size:15px;font-weight:600" onclick="navPage('withdraw')">æ ç°</button>
    </div>

    <!-- æ”¶æ”¯æ˜ç»† -->
    <div style="padding:0 16px;margin-top:18px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span style="font-size:13px;font-weight:600;color:#1B2E1B">æ”¶æ”¯æ˜ç»†</span>
        <span style="font-size:12px;color:#FF6F00;cursor:pointer" onclick="navPage('tx-list')">æŸ¥çœ‹å…¨éƒ¨ â€º</span>
      </div>
      <div class="card" id="wallet-tx-preview"></div>
    </div>

    <!-- æˆ‘çš„æ”¶æ¬¾è´¦æˆ· -->
    <div style="padding:0 16px;margin-top:18px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span style="font-size:13px;font-weight:600;color:#1B2E1B">æˆ‘çš„æ”¶æ¬¾è´¦æˆ·</span>
        <button class="btn btn-orange" style="height:32px;padding:0 14px;font-size:12px;border-radius:8px" onclick="navPage('add-account')">ï¼‹ æ·»åŠ è´¦æˆ·</button>
      </div>
      <div id="wallet-acct-list"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: ADD ACCOUNT  5.3.1.2
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-add-account">
  <div class="hdr" style="background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.10)">
    <button class="hdr-back" onclick="back()">â€¹</button>
    <div class="hdr-title" id="add-acct-title">æ·»åŠ æ”¶æ¬¾è´¦æˆ·</div>
    <div class="hdr-action"></div>
  </div>
  <div class="page-body" style="padding-bottom:24px">
    <div style="padding:20px 16px 0">
      <!-- æ­¥éª¤æ¡ -->
      <div class="step-bar" id="add-acct-steps">
        <div class="step-dot active" id="step1-dot">1</div>
        <div class="step-line pending" id="step-line"></div>
        <div class="step-dot pending" id="step2-dot">2</div>
      </div>

      <!-- Step 1: é€‰ç±»å‹ -->
      <div id="add-acct-step1">
        <div style="font-size:14px;font-weight:600;margin-bottom:14px;color:#1B2E1B">é€‰æ‹©è´¦æˆ·ç±»å‹</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" id="acct-type-grid">
          <div class="acct-type-card" onclick="selectAcctType('corporate',this)">
            <div class="acct-type-icon">ğŸ¢</div>
            <div class="acct-type-label">å¯¹å…¬é“¶è¡Œå¡</div>
          </div>
          <div class="acct-type-card" onclick="selectAcctType('personal',this)">
            <div class="acct-type-icon">ğŸ’³</div>
            <div class="acct-type-label">ä¸ªäººé“¶è¡Œå¡</div>
          </div>
          <div class="acct-type-card" onclick="selectAcctType('wechat',this)">
            <div class="acct-type-icon">ğŸ’š</div>
            <div class="acct-type-label">å¾®ä¿¡æ”¯ä»˜</div>
          </div>
          <div class="acct-type-card" onclick="selectAcctType('alipay',this)">
            <div class="acct-type-icon">ğŸ”µ</div>
            <div class="acct-type-label">æ”¯ä»˜å®</div>
          </div>
        </div>
        <button class="btn btn-orange btn-full" style="margin-top:20px;height:48px;border-radius:12px;font-size:15px" onclick="goAddAcctStep2()">ä¸‹ä¸€æ­¥</button>
      </div>

      <!-- Step 2: å¡«è¡¨å• -->
      <div id="add-acct-step2" style="display:none">
        <div style="font-size:14px;font-weight:600;margin-bottom:16px;color:#1B2E1B" id="add-acct-form-title"></div>
        <div id="add-acct-form"></div>
      </div>

      <!-- Step 3: æˆåŠŸ -->
      <div id="add-acct-success" style="display:none">
        <div class="success-screen">
          <div class="success-circle">âœ“</div>
          <div style="font-size:18px;font-weight:700;color:#1B2E1B;margin-bottom:8px" id="add-acct-success-title">ç»‘å®šæˆåŠŸ</div>
          <div style="font-size:13px;color:#5A7A5A;line-height:1.7;margin-bottom:32px" id="add-acct-success-desc">æ”¶æ¬¾è´¦æˆ·å·²æˆåŠŸç»‘å®šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥è´¦æˆ·è¿›è¡Œæç°æ“ä½œã€‚</div>
          <button class="btn btn-orange btn-full" style="height:48px;border-radius:12px;font-size:15px" onclick="navPage('wallet')">è¿”å›é’±åŒ…é¦–é¡µ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: TRANSACTION LIST  5.3.1.4
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-tx-list">
  <div class="hdr" style="background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.10)">
    <button class="hdr-back" onclick="back()">â€¹</button>
    <div class="hdr-title">æ”¶æ”¯æ˜ç»†</div>
    <div class="hdr-action"></div>
  </div>
  <div class="page-body" style="padding-bottom:24px">
    <!-- Filter tabs -->
    <div style="padding:10px 16px;background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.07);display:flex;gap:8px">
      <div class="chip active" id="tx-chip-all"      onclick="filterTx('all',this)">å…¨éƒ¨</div>
      <div class="chip"        id="tx-chip-income"   onclick="filterTx('income',this)">æ”¶å…¥</div>
      <div class="chip"        id="tx-chip-withdraw" onclick="filterTx('withdraw',this)">æç°</div>
    </div>
    <div style="padding:14px 16px 0" id="tx-full-list"></div>
    <div style="text-align:center;padding:20px;font-size:12px;color:#9DB89C" id="tx-load-more">â€” ä¸‹æ»‘åŠ è½½æ›´å¤š â€”</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: WITHDRAW  5.3.1.5
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-withdraw">
  <div class="hdr" style="background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.10)">
    <button class="hdr-back" onclick="back()">â€¹</button>
    <div class="hdr-title">æç°</div>
    <div class="hdr-action"></div>
  </div>
  <div class="page-body" style="padding-bottom:100px">
    <!-- ä½™é¢æç¤º -->
    <div style="background:linear-gradient(145deg,#E8F5E9,#F1F8E9);padding:18px 20px;margin:14px 16px 0;border-radius:14px;border:1px solid rgba(46,125,50,.12)">
      <div style="font-size:12px;color:#5A7A5A">å¯æç°ä½™é¢</div>
      <div style="font-family:var(--mono);font-size:28px;font-weight:700;color:#1B5E20;margin-top:4px">Â¥<span id="withdraw-balance">5,800.00</span></div>
    </div>

    <!-- æç°é‡‘é¢ -->
    <div style="margin:14px 16px 0;background:#FFFFFF;border-radius:14px;border:1px solid rgba(46,125,50,.10);padding:18px 20px;box-shadow:0 2px 10px rgba(46,125,50,.05)">
      <div style="font-size:13px;font-weight:600;color:#5A7A5A;margin-bottom:14px">æç°é‡‘é¢</div>
      <div style="display:flex;align-items:center;gap:8px;border-bottom:2px solid rgba(46,125,50,.15);padding-bottom:12px">
        <span style="font-size:24px;color:#9DB89C;font-family:var(--mono)">Â¥</span>
        <input class="withdraw-input" type="number" id="withdraw-amt" placeholder="0.00" min="0.01" step="0.01" oninput="validateWithdraw()">
        <button onclick="fillAllWithdraw()" style="white-space:nowrap;padding:6px 12px;background:var(--orange-dim);color:#FF6F00;border-radius:8px;font-size:12px;font-weight:600;font-family:var(--sans);border:none;cursor:pointer">å…¨éƒ¨æç°</button>
      </div>
      <div style="font-size:11px;color:#C62828;margin-top:6px;min-height:16px" id="withdraw-err"></div>
    </div>

    <!-- æ”¶æ¬¾æ–¹å¼ -->
    <div style="margin:12px 16px 0;background:#FFFFFF;border-radius:14px;border:1px solid rgba(46,125,50,.10);padding:18px 20px;box-shadow:0 2px 10px rgba(46,125,50,.05)">
      <div style="font-size:13px;font-weight:600;color:#5A7A5A;margin-bottom:12px">æ”¶æ¬¾æ–¹å¼</div>
      <div id="withdraw-acct-list"></div>
    </div>
  </div>

  <!-- åº•éƒ¨ç¡®è®¤æŒ‰é’® -->
  <div style="position:fixed;bottom:0;left:0;right:0;padding:12px 16px 32px;background:#FFFFFF;border-top:1px solid rgba(46,125,50,.10);box-shadow:0 -4px 20px rgba(46,125,50,.08)">
    <button class="btn btn-orange btn-full" style="height:48px;font-size:16px;font-weight:600;border-radius:12px" onclick="submitWithdraw()">ç¡®è®¤æç°</button>
  </div>
</div>

<!-- Withdraw Success Modal -->
<div class="modal-overlay" id="modal-withdraw-success">
  <div class="modal-sheet" style="text-align:center">
    <div class="modal-handle"></div>
    <div style="font-size:40px;margin-bottom:12px">ğŸ‰</div>
    <div style="font-size:18px;font-weight:700;margin-bottom:8px">æç°ç”³è¯·å·²æäº¤</div>
    <div style="font-size:13px;color:#5A7A5A;line-height:1.8;margin-bottom:28px">é¢„è®¡ 1â€“3 ä¸ªå·¥ä½œæ—¥åˆ°è´¦<br>è¯·ç•™æ„é“¶è¡Œ/æ”¯ä»˜å®/å¾®ä¿¡åˆ°è´¦é€šçŸ¥</div>
    <button class="btn btn-orange btn-full" style="height:48px;border-radius:12px;font-size:15px" onclick="closeModal('modal-withdraw-success');navPage('wallet')">è¿”å›é’±åŒ…</button>
  </div>
</div>

<!-- WeChat/Alipay Auth Modal -->
<div class="modal-overlay" id="modal-auth">
  <div class="modal-sheet" style="text-align:center">
    <div class="modal-handle"></div>
    <div style="font-size:36px;margin-bottom:12px" id="auth-icon">ğŸ’š</div>
    <div style="font-size:16px;font-weight:600;margin-bottom:8px" id="auth-title">å¾®ä¿¡æˆæƒç»‘å®š</div>
    <div style="font-size:13px;color:#5A7A5A;margin-bottom:24px">å³å°†è·³è½¬å¾®ä¿¡è¿›è¡Œæˆæƒï¼ŒæˆæƒæˆåŠŸåè‡ªåŠ¨ç»‘å®šã€‚</div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-auth')">å–æ¶ˆ</button>
      <button class="btn btn-orange btn-full" style="height:46px;border-radius:12px" onclick="confirmAuth()">ç¡®è®¤æˆæƒ</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav id="nav">
  <div class="nav-item active" id="nav-home" onclick="nav('home')">
    <span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é¡µ</span>
  </div>
  <div class="nav-item" id="nav-fields" onclick="nav('fields')">
    <span class="nav-icon">ğŸ—ºï¸</span><span class="nav-label">åœ°å—</span>
  </div>
  <div class="nav-item" id="nav-drone" onclick="nav('drone')">
    <span class="nav-icon">ğŸš</span><span class="nav-label">æ— äººæœº</span>
  </div>
  <div class="nav-item" id="nav-ndvi" onclick="nav('ndvi')">
    <span class="nav-icon">ğŸŒ¿</span><span class="nav-label">NDVI</span>
  </div>
  <div class="nav-item" id="nav-profile" onclick="nav('profile')" style="position:relative">
    <span class="nav-icon">ğŸ‘¤</span><span class="nav-label">æˆ‘çš„</span>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Add Field Modal -->
<div class="modal-overlay" id="modal-field">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="font-size:17px;font-weight:600;margin-bottom:20px">æ–°å¢åœ°å—</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="field"><span>ğŸ·ï¸</span><input type="text" id="new-field-name" placeholder="åœ°å—åç§°ï¼ˆå¦‚ï¼šAåŒº-å°éº¦ï¼‰"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field"><input type="number" id="new-field-area" placeholder="é¢ç§¯ï¼ˆäº©ï¼‰"></div>
        <div class="field">
          <select id="new-field-crop" style="flex:1;background:none;color:#1B2E1B;font-size:14px">
            <option value="">ä½œç‰©ç±»å‹</option>
            <option>å°éº¦</option><option>æ°´ç¨»</option><option>ç‰ç±³</option>
            <option>å¤§è±†</option><option>æ£‰èŠ±</option><option>æ²¹èœ</option>
          </select>
        </div>
      </div>
      <div class="field"><span>ğŸ“</span><input type="text" id="new-field-loc" placeholder="åœ°å—ä½ç½®æè¿°"></div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn btn-ghost btn-full" onclick="closeModal('modal-field')">å–æ¶ˆ</button>
        <button class="btn btn-primary btn-full" onclick="addField()">ç¡®è®¤æ·»åŠ </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Task Modal -->
<div class="modal-overlay" id="modal-task">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="font-size:17px;font-weight:600;margin-bottom:20px">åˆ›å»ºé£è¡Œä»»åŠ¡</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="field">
        <span>ğŸ“‹</span>
        <select id="new-task-field" style="flex:1;background:none;color:#1B2E1B;font-size:14px">
          <option value="">é€‰æ‹©ä½œä¸šåœ°å—</option>
        </select>
      </div>
      <div class="field">
        <span>ğŸ¯</span>
        <select id="new-task-type" style="flex:1;background:none;color:#1B2E1B;font-size:14px">
          <option>å¤šå…‰è°±å·¡ç”°ï¼ˆNDVIï¼‰</option>
          <option>RGBæ­£å°„å›¾é‡‡é›†</option>
          <option>æ™ºèƒ½ç—…å®³æ£€æµ‹</option>
          <option>ä½œç‰©è®¡æ•°</option>
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field"><span>âœˆï¸</span><input type="number" id="new-task-alt" placeholder="é£è¡Œé«˜åº¦(m)" value="90"></div>
        <div class="field"><span>ğŸ“¸</span><input type="number" id="new-task-overlap" placeholder="é‡å ç‡(%)" value="80"></div>
      </div>
      <div style="background:rgba(230,81,0,.08);border:1px solid var(--amber);border-radius:var(--r);padding:10px 12px;font-size:12px;color:#E65100">
        âš ï¸ é£è¡Œå‰è¯·ç¡®è®¤ç”µé‡â‰¥50%ã€é£é€Ÿï¼œ10m/sï¼Œå¹¶æ£€æŸ¥ç©ºåŸŸè®¸å¯
      </div>
      <div style="display:flex;gap:10px;margin-top:4px">
        <button class="btn btn-ghost btn-full" onclick="closeModal('modal-task')">å–æ¶ˆ</button>
        <button class="btn btn-primary btn-full" onclick="createTask()">åˆ›å»ºä»»åŠ¡</button>
      </div>
    </div>
  </div>
</div>

<!-- Irrigation Modal -->
<div class="modal-overlay" id="modal-irrigation">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="font-size:17px;font-weight:600;margin-bottom:4px">é˜€åŒºçŒæº‰æ§åˆ¶</div>
    <div style="font-size:12px;color:#5A7A5A;margin-bottom:20px">å®æ—¶æ§åˆ¶ Â· MQTT åè®®</div>
    <div style="display:flex;flex-direction:column;gap:10px" id="valve-list"></div>
    <button class="btn btn-ghost btn-full" style="margin-top:16px" onclick="closeModal('modal-irrigation')">å…³é—­</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: FARMLOG LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-farmlog">
  <div class="hdr" style="background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.10)">
    <button class="hdr-back" onclick="back()">â€¹</button>
    <div class="hdr-title">å†œäº‹è®°å½•</div>
    <button class="hdr-action" style="color:#2E7D32;font-size:22px;font-weight:300" onclick="navFarmlogAdd()">ï¼‹</button>
  </div>
  <div class="page-body" style="padding-bottom:24px">
    <!-- ç­›é€‰æ  -->
    <div style="padding:10px 16px;background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.08);display:flex;gap:8px;overflow-x:auto">
      <div class="chip active" id="fl-chip-all"    onclick="filterFarmlog('all',this)">å…¨éƒ¨</div>
      <div class="chip"        id="fl-chip-diary"  onclick="filterFarmlog('diary',this)">è®°äº‹</div>
      <div class="chip"        id="fl-chip-growth" onclick="filterFarmlog('growth',this)">æ—¥ç”Ÿé•¿é‡</div>
      <div class="chip"        id="fl-chip-pest"   onclick="filterFarmlog('pest',this)">å†œè¯</div>
      <div class="chip"        id="fl-chip-water"  onclick="filterFarmlog('water',this)">æ°´è‚¥</div>
      <div class="chip"        id="fl-chip-issue"  onclick="filterFarmlog('issue',this)">ç”°é—´é—®é¢˜</div>
    </div>
    <!-- ç»Ÿè®¡æ  -->
    <div style="padding:12px 16px;display:flex;gap:10px" id="fl-stats"></div>
    <!-- åˆ—è¡¨ -->
    <div style="padding:0 16px" id="fl-list"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: FARMLOG DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-farmlog-detail">
  <div class="hdr" style="background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.10)">
    <button class="hdr-back" onclick="back()">â€¹</button>
    <div class="hdr-title">è®°å½•è¯¦æƒ…</div>
    <div style="display:flex;gap:4px">
      <button onclick="exportFarmlogDetail()" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:18px">â¬‡</button>
      <button onclick="showFarmlogMenu()" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:20px;letter-spacing:1px;color:#5A7A5A">â‹¯</button>
    </div>
  </div>
  <div class="page-body" style="padding-bottom:24px" id="fl-detail-body"></div>
  <!-- æ›´å¤šèœå• -->
  <div id="fl-menu-mask" style="display:none;position:fixed;inset:0;z-index:150" onclick="closeFarmlogMenu()"></div>
  <div id="fl-menu" style="display:none;position:fixed;top:56px;right:12px;background:#FFFFFF;border:1px solid rgba(46,125,50,.15);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.12);z-index:160;overflow:hidden;min-width:120px">
    <div onclick="editFarmlog()" style="padding:14px 18px;font-size:14px;border-bottom:1px solid rgba(46,125,50,.08);cursor:pointer">âœï¸ ç¼–è¾‘</div>
    <div onclick="confirmDeleteFarmlog()" style="padding:14px 18px;font-size:14px;color:#C62828;cursor:pointer">ğŸ—‘ï¸ åˆ é™¤</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: FARMLOG ADD / EDIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-farmlog-add">
  <div class="hdr" style="background:#2E7D32">
    <button class="hdr-back" onclick="back()" style="color:#FFFFFF;background:rgba(255,255,255,.15)">â€¹</button>
    <div class="hdr-title" style="color:#FFFFFF" id="fl-add-title">æ·»åŠ å†œäº‹è®°å½•</div>
    <button onclick="saveFarmlogDraft()" style="font-size:13px;color:rgba(255,255,255,.85);padding:4px 8px">è‰ç¨¿</button>
  </div>
  <div class="page-body" style="padding-bottom:100px">
    <!-- å›ºå®šé¡¶éƒ¨è¡¨å• -->
    <div style="background:#FFFFFF;padding:14px 16px;border-bottom:1px solid rgba(46,125,50,.08)">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div>
          <div style="font-size:11px;color:#5A7A5A;margin-bottom:5px">æ‰€å±å†œåœº <span style="color:#C62828">*</span></div>
          <div class="field" style="padding:9px 12px">
            <select id="fl-farm" style="flex:1;background:none;color:#1B2E1B;font-size:13px" onchange="loadFlFields()">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="1" selected>åä¸œç¤ºèŒƒå†œåœº</option>
            </select>
          </div>
        </div>
        <div>
          <div style="font-size:11px;color:#5A7A5A;margin-bottom:5px">ä½œä¸šæ—¥æœŸ <span style="color:#C62828">*</span></div>
          <div class="field" style="padding:9px 12px">
            <input type="date" id="fl-date" style="flex:1;color:#1B2E1B;font-size:13px">
          </div>
        </div>
      </div>
      <div>
        <div style="font-size:11px;color:#5A7A5A;margin-bottom:5px">æ‰€å±åœ°å— <span style="color:#C62828">*</span></div>
        <div class="field" style="padding:9px 12px">
          <select id="fl-field-sel" style="flex:1;background:none;color:#1B2E1B;font-size:13px" onchange="onFlFieldChange()">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
        </div>
        <div id="fl-crop-hint" style="font-size:12px;color:#2E7D32;margin-top:5px;padding-left:2px;display:none">ğŸŒ± å½“å‰ç§æ¤ï¼š<span id="fl-crop-name"></span></div>
      </div>
    </div>

    <!-- ç±»å‹æ ‡ç­¾ -->
    <div style="background:#FFFFFF;border-bottom:1px solid rgba(46,125,50,.08)">
      <div style="padding:10px 16px 0;font-size:11px;color:#5A7A5A">è®°å½•ç±»å‹</div>
      <div style="display:flex;overflow-x:auto;padding:8px 12px 12px;gap:6px" id="fl-type-tabs">
        <button class="fl-type-btn active" data-type="diary"  onclick="switchFlType('diary',this)">ğŸ“‹ è®°äº‹</button>
        <button class="fl-type-btn"        data-type="growth" onclick="switchFlType('growth',this)">ğŸ“ æ—¥ç”Ÿé•¿é‡</button>
        <button class="fl-type-btn"        data-type="pest"   onclick="switchFlType('pest',this)">ğŸ§ª å†œè¯ä½¿ç”¨</button>
        <button class="fl-type-btn"        data-type="water"  onclick="switchFlType('water',this)">ğŸ’§ æ°´è‚¥ä½¿ç”¨</button>
        <button class="fl-type-btn"        data-type="issue"  onclick="switchFlType('issue',this)">âš ï¸ ç”°é—´é—®é¢˜</button>
      </div>
    </div>

    <!-- åŠ¨æ€è¡¨å•åŒºåŸŸ -->
    <div style="padding:16px" id="fl-form-body"></div>
  </div>
  <!-- åº•éƒ¨æäº¤ -->
  <div style="position:fixed;bottom:0;left:0;right:0;padding:12px 16px 32px;background:#FFFFFF;border-top:1px solid rgba(46,125,50,.10);box-shadow:0 -4px 20px rgba(46,125,50,.08)">
    <button class="btn btn-primary btn-full" style="height:48px;font-size:16px;border-radius:12px" onclick="submitFarmlog()">ğŸ“ æäº¤è®°å½•</button>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="modal-fl-delete">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="text-align:center;font-size:40px;margin-bottom:12px">ğŸ—‘ï¸</div>
    <div style="font-size:17px;font-weight:600;text-align:center;margin-bottom:8px">ç¡®è®¤åˆ é™¤</div>
    <div style="font-size:13px;color:#5A7A5A;text-align:center;margin-bottom:24px">åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™æ¡å†œäº‹è®°å½•å—ï¼Ÿ</div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-fl-delete')">å–æ¶ˆ</button>
      <button class="btn btn-full" style="background:#C62828;color:#FFFFFF;height:46px;border-radius:12px" onclick="doDeleteFarmlog()">ç¡®è®¤åˆ é™¤</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOCK API & DATA STORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
  user: { name: 'ç‹å¤§æ˜', phone: '13800138000', role: 'å†œæˆ·ç«¯Â·å¤§æ€»ç®¡' },
  fields: [
    { id:1, name:'AåŒºÂ·å°éº¦', area:320, crop:'å°éº¦', status:'growing', ndvi:0.68, location:'åŒ—å¤§æ²Ÿä¸œä¾§', color:'var(--green)' },
    { id:2, name:'BåŒºÂ·æ°´ç¨»', area:280, crop:'æ°´ç¨»', status:'growing', ndvi:0.72, location:'çŒæ¸ å—ä¾§', color:'var(--blue)' },
    { id:3, name:'CåŒºÂ·ç‰ç±³', area:410, crop:'ç‰ç±³', status:'alert',   ndvi:0.41, location:'è¥¿å¡æ¢¯ç”°', color:'var(--amber)' },
    { id:4, name:'DåŒºÂ·å¤§è±†', area:270, crop:'å¤§è±†', status:'growing', ndvi:0.65, location:'ä¸œå—è§’', color:'var(--green)' },
  ],
  tasks: [
    { id:1, field:'AåŒºÂ·å°éº¦', type:'å¤šå…‰è°±å·¡ç”°', status:'flying',  date:'2024-01-15 09:30', progress:62, photos:124, area:320 },
    { id:2, field:'CåŒºÂ·ç‰ç±³', type:'ç—…å®³æ£€æµ‹',   status:'done',    date:'2024-01-14 14:20', progress:100, photos:210, area:410 },
    { id:3, field:'BåŒºÂ·æ°´ç¨»', type:'RGBæ­£å°„å›¾',   status:'pending', date:'2024-01-16 08:00', progress:0,  photos:0,   area:280 },
    { id:4, field:'DåŒºÂ·å¤§è±†', type:'å¤šå…‰è°±å·¡ç”°', status:'done',    date:'2024-01-13 10:15', progress:100, photos:180, area:270 },
  ],
  alerts: [
    { id:1, type:'warn', level:'red',   icon:'ğŸŒ¡ï¸', title:'CåŒºç‰ç±³é«˜æ¸©é¢„è­¦', desc:'å½“å‰æ¸©åº¦ 38.2Â°Cï¼Œè¶…å‡ºè­¦æˆ’å€¼', time:'10åˆ†é’Ÿå‰',   read:false },
    { id:2, type:'warn', level:'amber', icon:'ğŸ’§', title:'BåŒºæ°´ç¨»çŒæº‰æé†’', desc:'åœŸå£¤æ¹¿åº¦ 42%ï¼Œå»ºè®®è¡¥å……çŒæº‰',   time:'1å°æ—¶å‰',    read:false },
    { id:3, type:'todo', level:'blue',  icon:'ğŸ“¸', title:'M3M ä»»åŠ¡å¾…å®¡æ ¸', desc:'BåŒºæ°´ç¨»RGBæ­£å°„å›¾ä»»åŠ¡éœ€ç¡®è®¤å‡ºå‘',time:'2å°æ—¶å‰',    read:false },
    { id:4, type:'msg',  level:'green', icon:'âœ…', title:'AåŒºå°éº¦NDVIåˆ†æå®Œæˆ', desc:'æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¹³å‡NDVI 0.68',  time:'æ˜¨å¤© 16:30', read:true },
    { id:5, type:'warn', level:'amber', icon:'ğŸš', title:'M3M ç”µé‡æé†’', desc:'ç”µé‡å‰©ä½™ 24%ï¼Œå»ºè®®åŠæ—¶å……ç”µ',     time:'æ˜¨å¤© 14:00', read:true },
    { id:6, type:'todo', level:'green', icon:'ğŸ“‹', title:'æœˆåº¦æŠ¥å‘Šå¾…ç¡®è®¤', desc:'1æœˆä»½å†œäº‹è®°å½•æ±‡æ€»å¾…å®¡æ ¸',        time:'1æœˆ10æ—¥',    read:true },
  ],
  valves: [
    { id:1, name:'AåŒºä¸»é˜€',   zone:'åŒ—å¤§æ²Ÿ', open:true,  flow:2.4 },
    { id:2, name:'BåŒºçŒæ¸ é˜€', zone:'çŒæ¸ å—', open:false, flow:0 },
    { id:3, name:'CåŒºæ»´çŒé˜€', zone:'è¥¿å¡',   open:true,  flow:1.8 },
    { id:4, name:'DåŒºé˜€é—¨',   zone:'ä¸œå—è§’', open:false, flow:0 },
  ]
};

const NDVI_DATA = {
  A: { avg:0.68, max:0.89, min:0.32, crop:'å°éº¦', bands:{G:0.72,R:0.38,RE:0.55,NIR:0.84}, health:[{label:'ä¼˜è‰¯(>0.6)',pct:58,color:'#2E7D32'},{label:'æ­£å¸¸(0.3-0.6)',pct:32,color:'#E65100'},{label:'è¾ƒå·®(<0.3)',pct:10,color:'#C62828'}] },
  B: { avg:0.72, max:0.91, min:0.41, crop:'æ°´ç¨»', bands:{G:0.75,R:0.35,RE:0.58,NIR:0.88}, health:[{label:'ä¼˜è‰¯(>0.6)',pct:71,color:'#2E7D32'},{label:'æ­£å¸¸(0.3-0.6)',pct:24,color:'#E65100'},{label:'è¾ƒå·®(<0.3)',pct:5,color:'#C62828'}] },
  C: { avg:0.41, max:0.72, min:0.12, crop:'ç‰ç±³', bands:{G:0.55,R:0.52,RE:0.41,NIR:0.65}, health:[{label:'ä¼˜è‰¯(>0.6)',pct:22,color:'#2E7D32'},{label:'æ­£å¸¸(0.3-0.6)',pct:51,color:'#E65100'},{label:'è¾ƒå·®(<0.3)',pct:27,color:'#C62828'}] },
  D: { avg:0.65, max:0.85, min:0.28, crop:'å¤§è±†', bands:{G:0.69,R:0.41,RE:0.52,NIR:0.81}, health:[{label:'ä¼˜è‰¯(>0.6)',pct:53,color:'#2E7D32'},{label:'æ­£å¸¸(0.3-0.6)',pct:38,color:'#E65100'},{label:'è¾ƒå·®(<0.3)',pct:9,color:'#C62828'}] },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPage = 'login';
let pageStack = [];

function nav(page) {
  const pages = ['home','fields','drone','ndvi','profile'];
  const isTab = pages.includes(page);

  document.querySelectorAll('.page').forEach(p => {
    p.classList.add('hidden'); p.classList.remove('prev');
  });

  const target = document.getElementById('page-' + page);
  if (target) { target.classList.remove('hidden','prev'); }

  // nav bar
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + page);
  if (navEl) navEl.classList.add('active');
  document.getElementById('nav').style.display = isTab ? 'flex' : 'none';

  if (!isTab) pageStack.push(currentPage);
  currentPage = page;

  // Init page data
  if (page === 'home')    initHome();
  if (page === 'fields')  initFields();
  if (page === 'drone')   initDrone();
  if (page === 'ndvi')    initNDVI('A');
  if (page === 'alerts')  initAlerts('all');
  if (page === 'tracking') startTracking();
  if (page === 'farmlog') initFarmlog();
}

function back() {
  const prev = pageStack.pop() || 'home';
  nav(prev);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchLoginTab(tab) {
  const btns = document.querySelectorAll('#login-tab button');
  btns[0].classList.toggle('active', tab==='login');
  btns[1].classList.toggle('active', tab==='register');
  document.getElementById('login-fields').style.display   = tab==='login' ? 'flex' : 'none';
  document.getElementById('register-fields').style.display = tab==='register' ? 'flex' : 'none';
}

function doLogin() {
  const phone = document.getElementById('login-phone').value;
  const pass  = document.getElementById('login-pass').value;
  if (!phone || !pass) { toast('è¯·å¡«å†™æ‰‹æœºå·å’Œå¯†ç '); return; }
  toast('ç™»å½•æˆåŠŸ âœ“');
  setTimeout(() => nav('home'), 500);
}

function doLogout() {
  nav('home');
  setTimeout(() => {
    document.querySelectorAll('.page').forEach(p => { p.classList.add('hidden'); p.classList.remove('prev'); });
    document.getElementById('page-login').classList.remove('hidden');
    document.getElementById('nav').style.display = 'none';
    currentPage = 'login';
    toast('å·²å®‰å…¨é€€å‡º');
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initHome() {
  const now = new Date();
  document.getElementById('home-date').textContent =
    `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${'æ—¥ä¸€äºŒä¸‰å››äº”å…­'[now.getDay()]}`;

  animateNum('stat-area', 1280, '');
  animateNum('stat-fields', DB.fields.length, '');
  animateNum('stat-flights', (DB.farmlogs||[]).length, '');
  animateNum('stat-alerts', 3, '');

  // recent farmlogs
  const recentFl = (DB.farmlogs||[]).slice(0,3);
  const flHtml = recentFl.length ? recentFl.map(r => {
    const t = FL_TYPE_MAP[r.type];
    return `<div class="fl-card" onclick="openFarmlogDetail(${r.id})" style="margin-bottom:8px">
      <div class="fl-card-hd">
        <span style="font-size:18px">${t.icon}</span>
        <span class="fl-type-tag" style="background:${t.bg};color:${t.color};font-size:10px">${t.label}</span>
        <span style="font-size:12px;color:#9DB89C;margin-left:auto">${r.date}</span>
      </div>
      <div class="fl-card-body" style="padding:10px 14px">
        <div style="font-size:13px;font-weight:500">${r.fieldName} <span style="font-weight:400;color:#9DB89C">Â· ${r.crop}</span></div>
        <div style="font-size:12px;color:#5A7A5A;margin-top:3px">${getFlPreview(r)}</div>
      </div>
    </div>`;
  }).join('') : '<div style="padding:24px;text-align:center;color:#9DB89C;font-size:13px;background:#FFFFFF;border-radius:14px;border:1px solid rgba(46,125,50,.08)">æš‚æ— è®°å½•</div>';
  document.getElementById('recent-farmlogs').innerHTML = flHtml;
  const taskHtml = DB.tasks.slice(0,3).map(t => `
    <div class="list-row" onclick="openTask(${t.id})">
      <div class="list-icon" style="background:${t.status==='flying'?'var(--blue-dim)':t.status==='done'?'var(--green-dim)':'var(--card2)'};font-size:20px">
        ${t.status==='flying'?'ğŸš':t.status==='done'?'âœ…':'â³'}
      </div>
      <div class="list-body">
        <div class="list-title">${t.field} Â· ${t.type}</div>
        <div class="list-sub">${t.date}</div>
        ${t.status==='flying'?`<div class="prog-wrap" style="margin-top:6px"><div class="prog-fill" style="width:${t.progress}%"></div></div>`:''}
      </div>
      <div class="list-right">
        <span class="badge ${t.status==='flying'?'badge-blue':t.status==='done'?'badge-green':'badge-amber'}">
          ${t.status==='flying'?'é£è¡Œä¸­':t.status==='done'?'å·²å®Œæˆ':'å¾…æ‰§è¡Œ'}
        </span>
      </div>
    </div>`).join('');
  document.getElementById('recent-tasks').innerHTML = taskHtml;

  // recent alerts
  const alertHtml = DB.alerts.filter(a => !a.read).slice(0,3).map(a => `
    <div class="alert-item" style="background:#FFFFFF;border:1px solid rgba(46,125,50,.09);border-radius:var(--r);">
      <div style="font-size:22px">${a.icon}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:500">${a.title}</div>
        <div style="font-size:12px;color:#5A7A5A;margin-top:2px">${a.desc}</div>
        <div style="font-size:11px;color:#9DB89C;margin-top:4px">${a.time}</div>
      </div>
      <span class="badge ${a.level==='red'?'badge-red':a.level==='amber'?'badge-amber':'badge-blue'}" style="font-size:10px">
        ${a.level==='red'?'ç´§æ€¥':a.level==='amber'?'è­¦å‘Š':'å¾…åŠ'}
      </span>
    </div>`).join('');
  document.getElementById('recent-alerts').innerHTML = alertHtml;
}

function animateNum(id, target, suffix) {
  const el = document.getElementById(id);
  if (!el) return;
  let cur = 0; const step = target / 30;
  const t = setInterval(() => {
    cur = Math.min(cur + step, target);
    el.textContent = Math.round(cur) + suffix;
    if (cur >= target) clearInterval(t);
  }, 20);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFields() {
  renderFields();
}

function renderFields() {
  document.getElementById('field-count').textContent = `å…± ${DB.fields.length} å—`;
  const html = DB.fields.map(f => `
    <div class="list-row" onclick="toast('æŸ¥çœ‹åœ°å—è¯¦æƒ…: ${f.name}')">
      <div class="list-icon" style="background:#F2F8F2;font-size:20px">ğŸŒ¾</div>
      <div class="list-body">
        <div class="list-title">${f.name}</div>
        <div class="list-sub">${f.location} Â· ${f.area}äº© Â· ${f.crop}</div>
        <div style="margin-top:6px">
          <div style="display:flex;align-items:center;gap:6px">
            <div class="prog-wrap" style="flex:1"><div class="prog-fill" style="width:${f.ndvi*100}%"></div></div>
            <span style="font-family:var(--mono);font-size:11px;color:#2E7D32;width:28px">NDVI ${f.ndvi}</span>
          </div>
        </div>
      </div>
      <div class="list-right">
        <span class="badge ${f.status==='alert'?'badge-red':'badge-green'}">
          ${f.status==='alert'?'é¢„è­¦':'æ­£å¸¸'}
        </span>
      </div>
    </div>`).join('');
  document.getElementById('field-list').innerHTML = html;
}

function showAddField() { openModal('modal-field'); }

function addField() {
  const name = document.getElementById('new-field-name').value;
  const area = parseFloat(document.getElementById('new-field-area').value) || 0;
  const crop = document.getElementById('new-field-crop').value;
  const loc  = document.getElementById('new-field-loc').value;
  if (!name || !area || !crop) { toast('è¯·å¡«å†™å®Œæ•´åœ°å—ä¿¡æ¯'); return; }
  DB.fields.push({ id: Date.now(), name, area, crop, status:'growing', ndvi:0.5, location:loc || 'å¾…å®š', color:'var(--green)' });
  closeModal('modal-field');
  renderFields();
  document.getElementById('new-field-name').value='';
  document.getElementById('new-field-area').value='';
  document.getElementById('new-field-crop').value='';
  document.getElementById('new-field-loc').value='';
  toast(`åœ°å—ã€Œ${name}ã€å·²æ·»åŠ `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let droneInterval = null;
let taskFilter = 'all';

function initDrone() {
  renderTasks();
  startDroneTelemetry();
}

function renderTasks(filter) {
  filter = filter || taskFilter;
  let tasks = filter === 'all' ? DB.tasks : DB.tasks.filter(t => t.status === filter);
  const html = tasks.map(t => `
    <div class="list-row" onclick="openTask(${t.id})" style="cursor:pointer">
      <div class="list-icon" style="background:${t.status==='flying'?'var(--blue-dim)':t.status==='done'?'var(--green-dim)':'var(--card2)'}">
        <span style="font-size:20px">${t.status==='flying'?'ğŸš':t.status==='done'?'âœ…':'â³'}</span>
      </div>
      <div class="list-body">
        <div class="list-title">${t.field}</div>
        <div class="list-sub">${t.type} Â· ${t.area}äº©</div>
        <div style="margin-top:5px;display:flex;align-items:center;gap:8px">
          ${t.status==='flying'?`<div class="prog-wrap" style="flex:1"><div class="prog-fill" style="width:${t.progress}%"></div></div><span style="font-family:var(--mono);font-size:10px;color:#2E7D32">${t.progress}%</span>`:`<span style="font-size:11px;color:#9DB89C">${t.date}</span>`}
        </div>
        ${t.status==='flying'?`<div style="font-size:11px;color:#1565C0;margin-top:3px;font-family:var(--mono)">å·²æ‹ ${t.photos} å¼ </div>`:''}
      </div>
      <div class="list-right">
        <span class="badge ${t.status==='flying'?'badge-blue':t.status==='done'?'badge-green':'badge-amber'}">
          ${t.status==='flying'?'é£è¡Œä¸­':t.status==='done'?'å·²å®Œæˆ':'å¾…æ‰§è¡Œ'}
        </span>
      </div>
    </div>`).join('') || '<div style="padding:30px;text-align:center;color:#9DB89C">æš‚æ— ä»»åŠ¡</div>';
  document.getElementById('task-list').innerHTML = html;
}

function filterTasks(f, el) {
  taskFilter = f;
  document.querySelectorAll('[id^="chip-"]').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderTasks(f);
}

function openTask(id) {
  const t = DB.tasks.find(x => x.id === id);
  if (!t) return;
  if (t.status === 'flying') {
    pageStack.push(currentPage);
    document.getElementById('tracking-title').textContent = `${t.field} Â· å®æ—¶è½¨è¿¹`;
    nav('tracking');
  } else if (t.status === 'done') {
    toast('æŸ¥çœ‹é£è¡ŒæŠ¥å‘Š');
  } else {
    toast('ä»»åŠ¡å°šæœªå¼€å§‹ï¼Œç¡®è®¤æ‰§è¡Œä¸­...');
  }
}

function showCreateTask() {
  const sel = document.getElementById('new-task-field');
  sel.innerHTML = '<option value="">é€‰æ‹©ä½œä¸šåœ°å—</option>' +
    DB.fields.map(f => `<option>${f.name}</option>`).join('');
  openModal('modal-task');
}

function createTask() {
  const field = document.getElementById('new-task-field').value;
  const type  = document.getElementById('new-task-type').value;
  const alt   = document.getElementById('new-task-alt').value;
  if (!field) { toast('è¯·é€‰æ‹©ä½œä¸šåœ°å—'); return; }
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  const f = DB.fields.find(x => x.name === field);
  DB.tasks.unshift({ id: Date.now(), field, type, status:'pending', date:dateStr, progress:0, photos:0, area:f?f.area:0 });
  closeModal('modal-task');
  renderTasks();
  toast(`ä»»åŠ¡å·²åˆ›å»ºï¼ŒKMZèˆªçº¿æ–‡ä»¶ç”Ÿæˆä¸­...`);
}

function startDroneTelemetry() {
  if (droneInterval) clearInterval(droneInterval);
  let batt = 82;
  droneInterval = setInterval(() => {
    const alt  = (88 + Math.random()*6).toFixed(1);
    const spd  = (7 + Math.random()*4).toFixed(1);
    const dist = Math.round(300 + Math.random()*200);
    document.getElementById('tele-alt').textContent = alt;
    document.getElementById('tele-spd').textContent = spd;
    document.getElementById('tele-dist').textContent = dist;
    batt = Math.max(0, batt - 0.05);
    document.getElementById('drone-batt').textContent = batt.toFixed(0) + '%';
    // update flying task progress
    const flyTask = DB.tasks.find(t => t.status==='flying');
    if (flyTask && flyTask.progress < 100) {
      flyTask.progress = Math.min(100, flyTask.progress + 0.3);
      flyTask.photos = Math.round(flyTask.progress * 2);
    }
  }, 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIVE TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let trackInterval = null;
let trackTime = 0;

function startTracking() {
  // Draw field polygon and flight path
  const svg = document.getElementById('track-svg');
  svg.innerHTML = `
    <polygon class="field-poly" points="40,30 200,20 220,160 50,170"/>
    <polyline class="flight-line" points="50,40 200,40 200,70 50,70 50,100 200,100 200,130 50,130"/>
  `;

  // Simulate drone movement along lawnmower pattern
  const path = [[50,40],[200,40],[200,70],[50,70],[50,100],[200,100],[200,130],[50,130]];
  let step = 0; let pct = 62;

  // Set initial position
  const icon = document.getElementById('drone-icon');
  icon.style.left = '50px'; icon.style.top = '40px';

  if (trackInterval) clearInterval(trackInterval);
  trackTime = 0;

  trackInterval = setInterval(() => {
    trackTime++;
    // Move drone
    if (step < path.length - 1) {
      const progress = (trackTime % 40) / 40;
      const [x1,y1] = path[step]; const [x2,y2] = path[step+1];
      icon.style.left = (x1 + (x2-x1)*progress) + 'px';
      icon.style.top  = (y1 + (y2-y1)*progress) + 'px';
      if (progress >= 0.99) step = (step+1) % (path.length-1);
    }

    // Update telemetry
    const alt   = (88 + Math.random()*6).toFixed(1);
    const spd   = (7 + Math.random()*3).toFixed(1);
    const batt  = Math.max(20, 78 - trackTime * 0.05);
    const photos = Math.round(124 + trackTime * 0.5);
    pct = Math.min(100, 62 + trackTime * 0.12);

    document.getElementById('rt-alt').textContent = alt + ' m';
    document.getElementById('rt-spd').textContent = spd + ' m/s';
    document.getElementById('rt-batt').textContent = batt.toFixed(0) + '%';
    document.getElementById('rt-batt-bar').style.width = batt + '%';
    document.getElementById('rt-batt-bar').style.background = batt < 30 ? 'linear-gradient(90deg,#C62828,#EF5350)' : '';
    document.getElementById('rt-photos').textContent = photos;
    document.getElementById('rt-progress').textContent = pct.toFixed(0) + '%';
    document.getElementById('rt-prog-bar').style.width = pct + '%';

    // Time
    const m = Math.floor(trackTime / 20); const s = (trackTime * 3) % 60;
    document.getElementById('rt-time').textContent = String(m).padStart(2,'0') + ':' + String(Math.round(s)).padStart(2,'0');

    // GPS
    const lng = (120.4523 + Math.random()*0.001).toFixed(4);
    const lat  = (30.7821 + Math.random()*0.001).toFixed(4);
    document.getElementById('track-pos').textContent = `${lng}Â°E  ${lat}Â°N`;

    // Multispectral
    const ndvi = (0.55 + Math.random()*0.18).toFixed(2);
    document.getElementById('ms-g').textContent   = (0.68 + Math.random()*.1).toFixed(2);
    document.getElementById('ms-r').textContent   = (0.32 + Math.random()*.1).toFixed(2);
    document.getElementById('ms-re').textContent  = (0.50 + Math.random()*.1).toFixed(2);
    document.getElementById('ms-nir').textContent = (0.80 + Math.random()*.1).toFixed(2);
    document.getElementById('rt-ndvi').textContent = ndvi;
    document.getElementById('ndvi-pointer').style.left = ((parseFloat(ndvi)+1)/2*100) + '%';
    const healthy = parseFloat(ndvi) > 0.5;
    document.getElementById('rt-ndvi-badge').className = 'badge ' + (healthy ? 'badge-green' : 'badge-amber');
    document.getElementById('rt-ndvi-badge').textContent = healthy ? 'å¥åº·' : 'éœ€å…³æ³¨';

  }, 500);
}

function pauseTask()    { toast('ä»»åŠ¡å·²æš‚åœï¼Œæ— äººæœºæ‚¬åœ'); clearInterval(trackInterval); }
function returnHome()   { toast('æ­£åœ¨è¿”èˆª...'); clearInterval(trackInterval); back(); }
function emergencyStop(){ toast('âš ï¸ ç´§æ€¥åœæ­¢æŒ‡ä»¤å·²å‘é€'); clearInterval(trackInterval); back(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NDVI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentNdviField = 'A';

function initNDVI(fieldKey) { renderNDVI(fieldKey); }

function selectNdviField(key, el) {
  document.querySelectorAll('.chip').forEach(c => { if(c.closest('#page-ndvi')) c.classList.remove('active'); });
  el.classList.add('active');
  renderNDVI(key);
}

function renderNDVI(key) {
  currentNdviField = key;
  const d = NDVI_DATA[key];
  document.getElementById('ndvi-avg').textContent = d.avg;
  document.getElementById('ndvi-max').textContent = d.max;
  document.getElementById('ndvi-min').textContent = d.min;

  // Health bars
  document.getElementById('health-bars').innerHTML = d.health.map(h => `
    <div style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:11px;color:#5A7A5A">${h.label}</span>
        <span style="font-family:var(--mono);font-size:11px;color:${h.color}">${h.pct}%</span>
      </div>
      <div class="prog-wrap"><div style="height:100%;border-radius:4px;background:${h.color};width:${h.pct}%;transition:width 1s ease"></div></div>
    </div>`).join('');

  // Band bars
  const bands = [
    {n:'Green',v:d.bands.G,c:'#2E7D32',nm:'560nm'},
    {n:'Red',v:d.bands.R,c:'#C62828',nm:'650nm'},
    {n:'Red Edge',v:d.bands.RE,c:'#E65100',nm:'730nm'},
    {n:'NIR',v:d.bands.NIR,c:'#1565C0',nm:'860nm'}
  ];
  document.getElementById('band-bars').innerHTML = bands.map(b => `
    <div style="text-align:center;padding:0 4px">
      <div style="height:80px;display:flex;align-items:flex-end;justify-content:center;margin-bottom:6px">
        <div style="width:28px;background:${b.c}33;border-radius:4px 4px 0 0;height:${b.v*100}%;min-height:10px;position:relative;border-top:2px solid ${b.c}">
          <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:10px;color:${b.c};white-space:nowrap">${b.v}</div>
        </div>
      </div>
      <div style="font-size:10px;font-weight:500;color:${b.c}">${b.n}</div>
      <div style="font-size:9px;color:#9DB89C">${b.nm}</div>
    </div>`).join('');

  // Insight
  const insights = {
    A: 'ğŸŒ¾ å°éº¦æ•´ä½“é•¿åŠ¿è‰¯å¥½ï¼ŒNIRåå°„ç‡é«˜ï¼ˆ0.84ï¼‰ï¼Œçº¢è¾¹æŒ‡æ•°æ­£å¸¸ï¼Œå»ºè®®å…³æ³¨NDVIä½äº0.3çš„10%åŒºåŸŸã€‚',
    B: 'ğŸŒ¾ æ°´ç¨»NDVIåˆ†å¸ƒå‡åŒ€ï¼Œå¥åº·æ¯”ä¾‹è¾¾71%ï¼Œç”Ÿé•¿çŠ¶æ€ä¼˜ç§€ã€‚å»ºè®®ä¸‹å‘¨è¡¥æµ‹ä¸€æ¬¡ç¡®è®¤åˆ†è˜–çŠ¶æ€ã€‚',
    C: 'âš ï¸ ç‰ç±³æ•´ä½“NDVIåä½ï¼Œå¹³å‡å€¼ä»…0.41ï¼ŒRedæ³¢æ®µåå°„ç‡å¼‚å¸¸ï¼ˆ0.52ï¼‰ï¼Œç–‘ä¼¼éƒ¨åˆ†åŒºåŸŸç—…å®³æˆ–ç¼ºæ°´ã€‚å»ºè®®48å°æ—¶å†…å·¡æŸ¥ã€‚',
    D: 'ğŸŒ± å¤§è±†ç”Ÿé•¿æ­£å¸¸ï¼Œå¹³å‡NDVI 0.65ï¼Œç»“åˆçº¢è¾¹æ•°æ®åˆ†ææ°®ç´ è¥å…»çŠ¶æ€è‰¯å¥½ã€‚'
  };
  document.getElementById('ndvi-insight').textContent = insights[key];

  // Prescription
  const prescriptions = {
    A: [{icon:'ğŸ’§',action:'è¡¥å……çŒæº‰',area:'32äº©',detail:'NDVI<0.3åŒºåŸŸå»ºè®®è¡¥å……çŒæº‰çº¦15mm'},{icon:'ğŸŒ¿',action:'æ–½ç”¨è¿½è‚¥',area:'96äº©',detail:'å»ºè®®æ–½ç”¨å°¿ç´ 10kg/äº©æå‡å«æ°®é‡'}],
    B: [{icon:'âœ…',action:'ç»´æŒç°çŠ¶',area:'å…¨åŒº',detail:'ç”Ÿé•¿çŠ¶æ€ä¼˜ç§€ï¼Œæ— éœ€ç‰¹æ®Šå¹²é¢„'},{icon:'ğŸ“…',action:'è®¡åˆ’æ”¶å‰²',area:'å…¨åŒº',detail:'é¢„è®¡30å¤©åå¯å®‰æ’æ”¶å‰²å‡†å¤‡'}],
    C: [{icon:'ğŸš¨',action:'ç´§æ€¥å·¡æŸ¥',area:'110äº©',detail:'NDVI<0.3åŒºåŸŸå 27%ï¼Œå»ºè®®ç«‹å³å®åœ°å‹˜æŸ¥'},{icon:'ğŸ’Š',action:'ç—…å®³é˜²æ²»',area:'74äº©',detail:'ç–‘ä¼¼çœŸèŒæ€§ç—…å®³ï¼Œå»ºè®®å–·æ–½æ€èŒå‰‚'},{icon:'ğŸ’§',action:'ç´§æ€¥è¡¥æ°´',area:'110äº©',detail:'é‡åº¦ç¼ºæ°´åŒºåŸŸå»ºè®®24å°æ—¶å†…è¡¥å……çŒæº‰'}],
    D: [{icon:'ğŸ“Š',action:'æŒç»­ç›‘æµ‹',area:'å…¨åŒº',detail:'å»ºè®®æ¯2å‘¨è¿›è¡Œä¸€æ¬¡NDVIé‡‡é›†ï¼Œè·Ÿè¸ªè±†èšå‘è‚²'},{icon:'ğŸ›',action:'è™«å®³é¢„é˜²',area:'å…¨åŒº',detail:'æ ¹æ®å¾€å¹´æ•°æ®ï¼Œå»ºè®®æå‰é˜²æ²»è±†èšèŸ'}]
  };
  document.getElementById('prescription').innerHTML = (prescriptions[key]||[]).map(p => `
    <div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:#F2F8F2;border-radius:var(--r);border:1px solid rgba(46,125,50,.09)">
      <div style="font-size:22px">${p.icon}</div>
      <div>
        <div style="font-size:13px;font-weight:600">${p.action} <span style="font-size:11px;color:#5A7A5A;font-weight:400">Â· ${p.area}</span></div>
        <div style="font-size:12px;color:#5A7A5A;margin-top:3px">${p.detail}</div>
      </div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAlerts(filter) { renderAlerts(filter); }

function switchAlertTab(filter, el) {
  document.querySelectorAll('#page-alerts .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderAlerts(filter);
}

function renderAlerts(filter) {
  let list = filter === 'all' ? DB.alerts : DB.alerts.filter(a => a.type === filter.replace('warn','warn').replace('todo','todo').replace('msg','msg'));
  if (filter === 'warn') list = DB.alerts.filter(a => a.type === 'warn');
  if (filter === 'todo') list = DB.alerts.filter(a => a.type === 'todo');
  if (filter === 'msg')  list = DB.alerts.filter(a => a.type === 'msg');

  const html = list.map(a => `
    <div class="alert-item" onclick="readAlert(${a.id})" style="background:#FFFFFF;border:1px solid ${a.read?'var(--border2)':'var(--border)'};border-left:3px solid ${a.level==='red'?'var(--red)':a.level==='amber'?'var(--amber)':a.level==='blue'?'var(--blue)':'var(--green)'};opacity:${a.read?.65:1}">
      <div style="font-size:24px">${a.icon}</div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:6px">
          <div style="font-size:14px;font-weight:${a.read?'400':'600'}">${a.title}</div>
          ${!a.read?'<div style="width:6px;height:6px;border-radius:50%;background:var(--red);flex-shrink:0"></div>':''}
        </div>
        <div style="font-size:12px;color:#5A7A5A;margin-top:3px">${a.desc}</div>
        <div style="font-size:11px;color:#9DB89C;margin-top:5px">${a.time}</div>
      </div>
      <span class="badge ${a.level==='red'?'badge-red':a.level==='amber'?'badge-amber':a.level==='blue'?'badge-blue':'badge-green'}" style="font-size:10px;align-self:flex-start">
        ${a.type==='warn'?'é¢„è­¦':a.type==='todo'?'å¾…åŠ':'æ¶ˆæ¯'}
      </span>
    </div>`).join('') || `<div style="padding:40px;text-align:center;color:#9DB89C">æš‚æ— ${filter==='warn'?'é¢„è­¦':filter==='todo'?'å¾…åŠ':'æ¶ˆæ¯'}</div>`;

  document.getElementById('alert-list').innerHTML = '<div style="display:flex;flex-direction:column;gap:8px">' + html + '</div>';
}

function readAlert(id) {
  const a = DB.alerts.find(x => x.id === id);
  if (a) { a.read = true; initAlerts('all'); toast('å·²æ ‡è®°ä¸ºå·²è¯»'); }
}

function markAllRead() {
  DB.alerts.forEach(a => a.read = true);
  renderAlerts('all');
  toast('å…¨éƒ¨å·²è¯»');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IRRIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showIrrigation() {
  renderValves();
  openModal('modal-irrigation');
}

function renderValves() {
  document.getElementById('valve-list').innerHTML = DB.valves.map(v => `
    <div style="background:#FFFFFF;border:1px solid rgba(46,125,50,.09);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:12px">
      <div style="font-size:22px">${v.open?'ğŸ’§':'ğŸ”´'}</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:500">${v.name}</div>
        <div style="font-size:12px;color:#5A7A5A;margin-top:2px">${v.zone} Â· ${v.open?`æµé‡ ${v.flow} L/s`:'å·²å…³é—­'}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="badge ${v.open?'badge-blue':'badge-amber'}">${v.open?'å¼€':'å…³'}</span>
        <div style="width:44px;height:24px;border-radius:12px;background:${v.open?'var(--green)':'var(--card2)'};border:1px solid rgba(46,125,50,.14);position:relative;cursor:pointer;transition:.3s" onclick="toggleValve(${v.id})">
          <div style="position:absolute;top:2px;${v.open?'right:2px':'left:2px'};width:18px;height:18px;border-radius:50%;background:${v.open?'#0C1A0B':'var(--text3)'};transition:.3s"></div>
        </div>
      </div>
    </div>`).join('');
}

function toggleValve(id) {
  const v = DB.valves.find(x => x.id === id);
  if (!v) return;
  v.open = !v.open;
  v.flow = v.open ? (1.5 + Math.random()).toFixed(1) : 0;
  renderValves();
  toast(`${v.name} å·²${v.open?'å¼€å¯':'å…³é—­'} â€” MQTTæŒ‡ä»¤å·²å‘é€`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FARM LOG DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DB.farmlogs = [
  {
    id:1, type:'growth', fieldId:1, fieldName:'AåŒºÂ·å°éº¦', farm:'åä¸œç¤ºèŒƒå†œåœº', crop:'å°éº¦',
    date:'2024-01-15', recorder:'ç‹å¤§æ˜',
    data:{ points:[
      {no:1, height:42, growth:1.2, leaves:6, stems:1},
      {no:2, height:45, growth:1.5, leaves:7, stems:1},
      {no:3, height:40, growth:0.9, leaves:6, stems:1}
    ]},
    photos:['ğŸŒ¾','ğŸŒ¿','ğŸ“·'], notes:'è§‚æµ‹ç‚¹å‡ä½äºç”°å—ä¸­éƒ¨ï¼Œæ— æ˜æ˜¾å·®å¼‚ã€‚'
  },
  {
    id:2, type:'water', fieldId:2, fieldName:'BåŒºÂ·æ°´ç¨»', farm:'åä¸œç¤ºèŒƒå†œåœº', crop:'æ°´ç¨»',
    date:'2024-01-14', recorder:'å¼ ä¸‰',
    data:{ waterAmt:35, fertilizers:[
      {no:1, name:'å°¿ç´ ', amount:8, N:46, P:0, K:0},
      {no:2, name:'å¤åˆè‚¥', amount:15, N:15, P:15, K:15}
    ]},
    photos:['ğŸ’§','ğŸ“·'], notes:'æŒ‰è®¡åˆ’æ–½è‚¥ï¼Œå¤©æ°”æ™´å¥½ã€‚'
  },
  {
    id:3, type:'pest', fieldId:3, fieldName:'CåŒºÂ·ç‰ç±³', farm:'åä¸œç¤ºèŒƒå†œåœº', crop:'ç‰ç±³',
    date:'2024-01-13', recorder:'ç‹å¤§æ˜',
    data:{ pesticides:[
      {no:1, name:'ç”²ç»´ç›', effect:'é˜²æ²»ç‰ç±³èŸ', amount:8},
      {no:2, name:'å¡è™«å•‰', effect:'é˜²æ²»èšœè™«',   amount:6}
    ]},
    photos:['ğŸ§ª','ğŸŒ½','ğŸ“·'], notes:'é‡ç‚¹å¤„ç†ä¸œåŒ—è§’åŒºåŸŸã€‚'
  },
  {
    id:4, type:'issue', fieldId:3, fieldName:'CåŒºÂ·ç‰ç±³', farm:'åä¸œç¤ºèŒƒå†œåœº', crop:'ç‰ç±³',
    date:'2024-01-12', recorder:'æå››',
    data:{ desc:'å‘ç°ç‰ç±³å¶ç‰‡å‡ºç°é»„åŒ–ç°è±¡ï¼Œé¢ç§¯çº¦30äº©ï¼Œç–‘ä¼¼ç¼ºæ°®æˆ–ç—…å®³å¼•èµ·ã€‚', issueType:'ç¼ºç´ ', severity:'medium'},
    photos:['âš ï¸','ğŸŒ½'], notes:'å·²é€šçŸ¥æŠ€æœ¯å‘˜å‰æ¥å‹˜æŸ¥ã€‚'
  },
  {
    id:5, type:'diary', fieldId:4, fieldName:'DåŒºÂ·å¤§è±†', farm:'åä¸œç¤ºèŒƒå†œåœº', crop:'å¤§è±†',
    date:'2024-01-10', recorder:'ç‹å¤§æ˜',
    data:{ content:'ä»Šæ—¥å¯¹DåŒºå¤§è±†è¿›è¡Œäº†ä¾‹è¡Œå·¡æŸ¥ï¼Œæ•´ä½“é•¿åŠ¿è‰¯å¥½ï¼Œæ— æ˜æ˜¾ç—…è™«å®³è¿¹è±¡ã€‚åœŸå£¤æ¹¿åº¦é€‚ä¸­ï¼Œé¢„è®¡æœ¬æœˆåº•å¯è¿›å…¥é¼“ç²’æœŸã€‚'},
    photos:['ğŸŒ±','ğŸ“·'], notes:''
  }
];

const FL_TYPE_MAP = {
  diary:  { label:'è®°äº‹',     color:'#43A047', bg:'rgba(46,125,50,.10)',  icon:'ğŸ“‹' },
  growth: { label:'æ—¥ç”Ÿé•¿é‡', color:'#1565C0', bg:'rgba(21,101,192,.10)', icon:'ğŸ“' },
  pest:   { label:'å†œè¯ä½¿ç”¨', color:'#E65100', bg:'rgba(230,81,0,.10)',   icon:'ğŸ§ª' },
  water:  { label:'æ°´è‚¥ä½¿ç”¨', color:'#0277BD', bg:'rgba(2,119,189,.10)',  icon:'ğŸ’§' },
  issue:  { label:'ç”°é—´é—®é¢˜', color:'#C62828', bg:'rgba(198,40,40,.10)',  icon:'âš ï¸' },
};
const SEV_MAP = { light:'è½»å¾®', medium:'ä¸­ç­‰', heavy:'ä¸¥é‡' };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FARMLOG LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let flFilter = 'all';

function initFarmlog() {
  renderFlStats();
  renderFlList(flFilter);
}

function filterFarmlog(type, el) {
  flFilter = type;
  document.querySelectorAll('[id^="fl-chip-"]').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderFlList(type);
}

function renderFlStats() {
  const counts = {};
  DB.farmlogs.forEach(r => counts[r.type] = (counts[r.type]||0)+1);
  const total = DB.farmlogs.length;
  const items = [
    {label:'å…¨éƒ¨', val:total, color:'#2E7D32', bg:'rgba(46,125,50,.08)'},
    ...Object.entries(FL_TYPE_MAP).map(([k,v]) => ({label:v.label, val:counts[k]||0, color:v.color, bg:v.bg}))
  ];
  document.getElementById('fl-stats').innerHTML = items.slice(0,4).map(i=>
    `<div style="flex:1;background:${i.bg};border-radius:10px;padding:10px 8px;text-align:center">
      <div style="font-family:var(--mono);font-size:18px;font-weight:600;color:${i.color}">${i.val}</div>
      <div style="font-size:10px;color:#5A7A5A;margin-top:2px">${i.label}</div>
    </div>`
  ).join('');
}

function renderFlList(filter) {
  const list = filter === 'all' ? DB.farmlogs : DB.farmlogs.filter(r=>r.type===filter);
  const sorted = [...list].sort((a,b)=>b.date.localeCompare(a.date));
  if (!sorted.length) {
    document.getElementById('fl-list').innerHTML =
      '<div style="padding:48px 0;text-align:center;color:#9DB89C;font-size:14px">æš‚æ— è®°å½•ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>';
    return;
  }
  document.getElementById('fl-list').innerHTML = sorted.map(r => {
    const t = FL_TYPE_MAP[r.type];
    const preview = getFlPreview(r);
    return `<div class="fl-card" onclick="openFarmlogDetail(${r.id})">
      <div class="fl-card-hd">
        <span style="font-size:20px">${t.icon}</span>
        <span class="fl-type-tag" style="background:${t.bg};color:${t.color}">${t.label}</span>
        <span style="font-size:12px;color:#9DB89C;margin-left:auto">${r.date}</span>
      </div>
      <div class="fl-card-body">
        <div style="font-size:13px;font-weight:600;margin-bottom:4px">${r.fieldName} <span style="font-weight:400;color:#9DB89C">Â· ${r.crop}</span></div>
        <div style="font-size:12px;color:#5A7A5A;line-height:1.6">${preview}</div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <span style="font-size:11px;color:#9DB89C">ğŸ“· ${r.photos.length}å¼ </span>
          <span style="font-size:11px;color:#9DB89C">ğŸ‘¤ ${r.recorder}</span>
          ${r.notes?`<span style="font-size:11px;color:#9DB89C">å¤‡æ³¨å·²å¡«</span>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function getFlPreview(r) {
  if (r.type==='diary')  return r.data.content.slice(0,60)+(r.data.content.length>60?'â€¦':'');
  if (r.type==='growth') return `å…± ${r.data.points.length} ä¸ªè§‚æµ‹ç‚¹ï¼Œå¹³å‡æ ªé«˜ ${(r.data.points.reduce((s,p)=>s+p.height,0)/r.data.points.length).toFixed(1)}cm`;
  if (r.type==='pest')   return `ä½¿ç”¨å†œè¯ ${r.data.pesticides.length} ç§ï¼š${r.data.pesticides.map(p=>p.name).join('ã€')}`;
  if (r.type==='water')  return `äº©ç”¨æ°´ ${r.data.waterAmt}mÂ³ï¼ŒåŒ–è‚¥ ${r.data.fertilizers.length} ç§`;
  if (r.type==='issue')  return `${r.data.issueType} Â· ${SEV_MAP[r.data.severity]} Â· ${r.data.desc.slice(0,40)}â€¦`;
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FARMLOG DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentFlId = null;

function openFarmlogDetail(id) {
  currentFlId = id;
  const r = DB.farmlogs.find(x=>x.id===id);
  if (!r) { toast('è®°å½•ä¸å­˜åœ¨'); return; }

  // Use main nav
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById('page-farmlog-detail').classList.remove('hidden');
  document.getElementById('nav').style.display = 'none';
  pageStack.push(currentPage);
  currentPage = 'farmlog-detail';
  renderFlDetail(id);
}

function renderFlDetail(id) {
  const r = DB.farmlogs.find(x=>x.id===id);
  if (!r) {
    document.getElementById('fl-detail-body').innerHTML =
      '<div style="padding:48px;text-align:center;color:#9DB89C">è®°å½•ä¸å­˜åœ¨</div>';
    return;
  }
  const t = FL_TYPE_MAP[r.type];
  let detailHtml = '';

  if (r.type==='diary') {
    detailHtml = `<div class="fl-section-body">
      <div style="font-size:14px;color:#1B2E1B;line-height:1.8">${r.data.content}</div>
    </div>`;
  } else if (r.type==='growth') {
    detailHtml = `<div class="fl-section-body">
      ${r.data.points.map(p=>`
        <div style="background:#F7FAF7;border-radius:10px;padding:12px;margin-bottom:8px">
          <div style="font-size:12px;font-weight:600;color:#2E7D32;margin-bottom:8px">è§‚æµ‹ç‚¹ ${p.no}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div class="fl-row"><span class="fl-row-label">æ ªé«˜</span><span class="fl-row-val" style="font-family:var(--mono)">${p.height} <span style="font-size:11px;color:#9DB89C">cm</span></span></div>
            <div class="fl-row"><span class="fl-row-label">æ—¥ç”Ÿé•¿é‡</span><span class="fl-row-val" style="font-family:var(--mono)">${p.growth} <span style="font-size:11px;color:#9DB89C">cm</span></span></div>
            <div class="fl-row"><span class="fl-row-label">å¶æ•°</span><span class="fl-row-val" style="font-family:var(--mono)">${p.leaves} <span style="font-size:11px;color:#9DB89C">ç‰‡</span></span></div>
            <div class="fl-row"><span class="fl-row-label">å°æ•°</span><span class="fl-row-val" style="font-family:var(--mono)">${p.stems} <span style="font-size:11px;color:#9DB89C">å°</span></span></div>
          </div>
        </div>`).join('')}
    </div>`;
  } else if (r.type==='pest') {
    detailHtml = `<div class="fl-section-body">
      ${r.data.pesticides.map(p=>`
        <div style="background:#F7FAF7;border-radius:10px;padding:12px;margin-bottom:8px">
          <div style="font-size:12px;font-weight:600;color:#E65100;margin-bottom:8px">å†œè¯ ${p.no}</div>
          <div class="fl-row"><span class="fl-row-label">åç§°</span><span class="fl-row-val">${p.name}</span></div>
          <div class="fl-row"><span class="fl-row-label">ä¸»è¦ä½œç”¨</span><span class="fl-row-val">${p.effect}</span></div>
          <div class="fl-row"><span class="fl-row-label">ç”¨é‡</span><span class="fl-row-val" style="font-family:var(--mono)">${p.amount} <span style="font-size:11px;color:#9DB89C">g/äº©</span></span></div>
        </div>`).join('')}
    </div>`;
  } else if (r.type==='water') {
    detailHtml = `<div class="fl-section-body">
      <div class="fl-row"><span class="fl-row-label">äº©ç”¨æ°´é‡</span><span class="fl-row-val" style="font-family:var(--mono);color:#0277BD">${r.data.waterAmt} <span style="font-size:11px;color:#9DB89C">mÂ³</span></span></div>
      <div style="font-size:12px;color:#9DB89C;margin:10px 0 8px">åŒ–è‚¥æ˜ç»†</div>
      ${r.data.fertilizers.map(f=>`
        <div style="background:#F7FAF7;border-radius:10px;padding:12px;margin-bottom:8px">
          <div style="font-size:12px;font-weight:600;color:#0277BD;margin-bottom:8px">åŒ–è‚¥ ${f.no} Â· ${f.name}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px">
            <div style="text-align:center"><div style="font-family:var(--mono);font-size:14px;font-weight:600">${f.amount}</div><div style="font-size:10px;color:#9DB89C">kg/äº©</div></div>
            <div style="text-align:center"><div style="font-family:var(--mono);font-size:14px;font-weight:600;color:#43A047">${f.N}%</div><div style="font-size:10px;color:#9DB89C">æ°®(N)</div></div>
            <div style="text-align:center"><div style="font-family:var(--mono);font-size:14px;font-weight:600;color:#E65100">${f.P}%</div><div style="font-size:10px;color:#9DB89C">ç£·(P)</div></div>
            <div style="text-align:center"><div style="font-family:var(--mono);font-size:14px;font-weight:600;color:#1565C0">${f.K}%</div><div style="font-size:10px;color:#9DB89C">é’¾(K)</div></div>
          </div>
        </div>`).join('')}
    </div>`;
  } else if (r.type==='issue') {
    const sevColor = {light:'#2E7D32',medium:'#E65100',heavy:'#C62828'}[r.data.severity];
    const sevBg    = {light:'rgba(46,125,50,.08)',medium:'rgba(230,81,0,.08)',heavy:'rgba(198,40,40,.08)'}[r.data.severity];
    detailHtml = `<div class="fl-section-body">
      <div class="fl-row"><span class="fl-row-label">é—®é¢˜ç±»å‹</span><span class="fl-row-val">${r.data.issueType}</span></div>
      <div class="fl-row"><span class="fl-row-label">ä¸¥é‡ç¨‹åº¦</span>
        <span style="background:${sevBg};color:${sevColor};padding:2px 10px;border-radius:12px;font-size:12px;font-weight:500">${SEV_MAP[r.data.severity]}</span>
      </div>
      <div class="fl-row" style="align-items:flex-start"><span class="fl-row-label">é—®é¢˜æè¿°</span><span class="fl-row-val" style="line-height:1.7">${r.data.desc}</span></div>
    </div>`;
  }

  document.getElementById('fl-detail-body').innerHTML = `
    <div style="padding:0 16px;margin-top:14px">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div class="fl-section">
        <div class="fl-section-title">åŸºæœ¬ä¿¡æ¯</div>
        <div class="fl-section-body">
          <div class="fl-row"><span class="fl-row-label">è®°å½•æ—¶é—´</span><span class="fl-row-val">${r.date} 09:00</span></div>
          <div class="fl-row"><span class="fl-row-label">åœ°å—</span><span class="fl-row-val">${r.fieldName} <span style="color:#9DB89C">(${r.farm})</span></span></div>
          <div class="fl-row"><span class="fl-row-label">ç±»å‹</span>
            <span class="fl-type-tag" style="background:${t.bg};color:${t.color}">${t.icon} ${t.label}</span>
          </div>
          <div class="fl-row"><span class="fl-row-label">è®°å½•äºº</span><span class="fl-row-val">${r.recorder}</span></div>
        </div>
      </div>
      <!-- è¯¦æƒ… -->
      <div class="fl-section">
        <div class="fl-section-title">è¯¦ç»†ä¿¡æ¯</div>
        ${detailHtml}
      </div>
      <!-- ç…§ç‰‡ -->
      ${r.photos.length ? `
      <div class="fl-section">
        <div class="fl-section-title">ä½œä¸šç…§ç‰‡ï¼ˆ${r.photos.length}å¼ ï¼‰</div>
        <div class="fl-section-body">
          <div class="photo-scroll">
            ${r.photos.map((p,i)=>`<div class="photo-thumb" onclick="toast('æŸ¥çœ‹å¤§å›¾ ${i+1}')">${p}</div>`).join('')}
          </div>
        </div>
      </div>` : ''}
      <!-- å¤‡æ³¨ -->
      ${r.notes ? `
      <div class="fl-section">
        <div class="fl-section-title">å¤‡æ³¨</div>
        <div class="fl-section-body" style="font-size:13px;color:#5A7A5A;line-height:1.7">${r.notes}</div>
      </div>` : ''}
    </div>`;
}

function showFarmlogMenu() {
  document.getElementById('fl-menu').style.display = 'block';
  document.getElementById('fl-menu-mask').style.display = 'block';
}
function closeFarmlogMenu() {
  document.getElementById('fl-menu').style.display = 'none';
  document.getElementById('fl-menu-mask').style.display = 'none';
}
function editFarmlog() {
  closeFarmlogMenu();
  navFarmlogAdd(currentFlId);
}
function confirmDeleteFarmlog() {
  closeFarmlogMenu();
  openModal('modal-fl-delete');
}
function doDeleteFarmlog() {
  DB.farmlogs = DB.farmlogs.filter(r=>r.id!==currentFlId);
  closeModal('modal-fl-delete');
  toast('åˆ é™¤æˆåŠŸ');
  // Navigate back to list and refresh
  setTimeout(() => {
    const prev = pageStack.pop() || 'farmlog';
    document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
    const target = document.getElementById('page-' + (prev === 'farmlog' ? 'farmlog' : prev));
    if (target) target.classList.remove('hidden');
    const isTab = ['home','fields','drone','ndvi','profile'].includes(prev);
    document.getElementById('nav').style.display = isTab ? 'flex' : 'none';
    currentPage = prev;
    if (prev === 'farmlog') initFarmlog();
  }, 400);
}
function exportFarmlogDetail() {
  toast('æ­£åœ¨å¯¼å‡º Excel æ–‡ä»¶â€¦');
  setTimeout(()=>toast('å¯¼å‡ºæˆåŠŸï¼Œæ–‡ä»¶å·²ä¿å­˜'), 1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FARMLOG ADD / EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let flCurrentType = 'diary';
let flEditId = null;
let flGrowthPoints = [];
let flPesticides = [];
let flFertilizers = [];
let flSeverity = 'light';
let flPhotos = [];

function navFarmlogAdd(editId) {
  flEditId = editId || null;
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById('page-farmlog-add').classList.remove('hidden');
  document.getElementById('nav').style.display = 'none';
  pageStack.push(currentPage);
  currentPage = 'farmlog-add';
  initFarmlogAdd();
}

function initFarmlogAdd() {
  // Set today date
  const today = new Date();
  const d = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  document.getElementById('fl-date').value = d;
  document.getElementById('fl-date').max = d;

  // Populate field dropdown
  const sel = document.getElementById('fl-field-sel');
  sel.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°å—</option>' +
    DB.fields.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');

  // Reset
  flGrowthPoints = []; flPesticides = []; flFertilizers = [];
  flSeverity = 'light'; flPhotos = [];

  if (flEditId) {
    // Pre-fill for edit
    document.getElementById('fl-add-title').textContent = 'ç¼–è¾‘å†œäº‹è®°å½•';
    const r = DB.farmlogs.find(x=>x.id===flEditId);
    if (r) {
      sel.value = r.fieldId;
      onFlFieldChange();
      document.getElementById('fl-date').value = r.date;
      switchFlType(r.type, document.querySelector(`[data-type="${r.type}"]`));
      if (r.type==='growth') flGrowthPoints = r.data.points.map(p=>({...p}));
      if (r.type==='pest')   flPesticides = r.data.pesticides.map(p=>({...p}));
      if (r.type==='water')  { flFertilizers = r.data.fertilizers.map(f=>({...f})); }
      if (r.type==='issue')  flSeverity = r.data.severity;
      flPhotos = [...r.photos];
    }
  } else {
    document.getElementById('fl-add-title').textContent = 'æ·»åŠ å†œäº‹è®°å½•';
    switchFlType('diary', document.querySelector('[data-type="diary"]'));
  }
}

function loadFlFields() { /* farms only one in demo */ }

function onFlFieldChange() {
  const id = parseInt(document.getElementById('fl-field-sel').value);
  const field = DB.fields.find(f=>f.id===id);
  const hint = document.getElementById('fl-crop-hint');
  if (field) {
    hint.style.display = 'block';
    document.getElementById('fl-crop-name').textContent = field.crop;
  } else {
    hint.style.display = 'none';
  }
}

function switchFlType(type, el) {
  flCurrentType = type;
  document.querySelectorAll('.fl-type-btn').forEach(b=>b.classList.remove('active'));
  if (el) el.classList.add('active');
  renderFlForm(type);
}

function renderFlForm(type) {
  const body = document.getElementById('fl-form-body');
  let html = '';

  if (type === 'diary') {
    html = `
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:#5A7A5A;margin-bottom:6px">è®°äº‹å†…å®¹ <span style="color:#C62828">*</span> <span style="color:#9DB89C;float:right" id="diary-count">0/500</span></div>
        <textarea id="fl-diary-content" maxlength="500" rows="6"
          style="width:100%;background:#F7FAF7;border:1.5px solid rgba(46,125,50,.2);border-radius:10px;padding:12px;font-size:14px;color:#1B2E1B;font-family:var(--sans);resize:none;line-height:1.7"
          placeholder="è¯·è¾“å…¥ä»Šå¤©çš„å†œäº‹è®°å½•å†…å®¹â€¦"
          oninput="document.getElementById('diary-count').textContent=this.value.length+'/500'"></textarea>
      </div>`;
  } else if (type === 'growth') {
    html = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:12px;color:#5A7A5A">è§‚æµ‹ç‚¹åˆ—è¡¨ <span style="color:#C62828">*</span></span>
          <span style="font-size:11px;color:#9DB89C" id="growth-count">0/10 ä¸ª</span>
        </div>
        <div id="growth-points"></div>
        <button class="add-row-btn" id="growth-add-btn" onclick="addGrowthPoint()">ï¼‹ æ·»åŠ è§‚æµ‹ç‚¹</button>
      </div>`;
  } else if (type === 'pest') {
    html = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:12px;color:#5A7A5A">å†œè¯åˆ—è¡¨ <span style="color:#C62828">*</span></span>
          <span style="font-size:11px;color:#9DB89C" id="pest-count">0/10 ç§</span>
        </div>
        <div id="pest-list"></div>
        <button class="add-row-btn" id="pest-add-btn" onclick="addPesticide()">ï¼‹ æ·»åŠ å†œè¯</button>
      </div>`;
  } else if (type === 'water') {
    html = `
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:#5A7A5A;margin-bottom:6px">äº©ç”¨æ°´é‡ï¼ˆmÂ³ï¼‰ <span style="color:#C62828">*</span></div>
        <div class="field" style="padding:10px 14px">
          <span style="color:#0277BD">ğŸ’§</span>
          <input type="number" id="fl-water-amt" placeholder="è¯·è¾“å…¥äº©ç”¨æ°´é‡" min="0" max="9999" style="flex:1;font-size:15px;color:#1B2E1B">
          <span style="color:#9DB89C;font-size:13px">mÂ³</span>
        </div>
      </div>
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:12px;color:#5A7A5A">åŒ–è‚¥åˆ—è¡¨</span>
          <span style="font-size:11px;color:#9DB89C" id="fert-count">0/10 ç§</span>
        </div>
        <div id="fert-list"></div>
        <button class="add-row-btn" id="fert-add-btn" onclick="addFertilizer()">ï¼‹ æ·»åŠ åŒ–è‚¥</button>
      </div>`;
  } else if (type === 'issue') {
    html = `
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:#5A7A5A;margin-bottom:6px">é—®é¢˜æè¿° <span style="color:#C62828">*</span> <span style="color:#9DB89C;float:right" id="issue-count">0/500</span></div>
        <textarea id="fl-issue-desc" maxlength="500" rows="5"
          style="width:100%;background:#F7FAF7;border:1.5px solid rgba(46,125,50,.2);border-radius:10px;padding:12px;font-size:14px;color:#1B2E1B;font-family:var(--sans);resize:none;line-height:1.7"
          placeholder="è¯·è¯¦ç»†æè¿°ç”°é—´å‘ç°çš„é—®é¢˜â€¦"
          oninput="document.getElementById('issue-count').textContent=this.value.length+'/500'"></textarea>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:#5A7A5A;margin-bottom:6px">é—®é¢˜ç±»å‹ <span style="color:#C62828">*</span></div>
        <div class="field" style="padding:9px 12px">
          <select id="fl-issue-type" style="flex:1;background:none;color:#1B2E1B;font-size:14px;font-family:var(--sans)">
            <option value="">è¯·é€‰æ‹©</option>
            <option>ç—…è™«å®³</option><option>æ‚è‰</option><option>ç¼ºç´ </option>
            <option>å¹²æ—±</option><option>æ¶å®³</option><option>å†»å®³</option><option>å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:#5A7A5A;margin-bottom:8px">ä¸¥é‡ç¨‹åº¦ <span style="color:#C62828">*</span></div>
        <div class="severity-group" id="sev-group">
          <button class="sev-btn active-light" onclick="setSeverity('light',this)">è½»å¾®</button>
          <button class="sev-btn" onclick="setSeverity('medium',this)">ä¸­ç­‰</button>
          <button class="sev-btn" onclick="setSeverity('heavy',this)">ä¸¥é‡</button>
        </div>
      </div>`;
  }

  // Common: photo upload + notes
  html += `
    <div style="margin-bottom:16px">
      <div style="font-size:12px;color:#5A7A5A;margin-bottom:8px">ä½œä¸šç…§ç‰‡ <span style="color:#9DB89C">ï¼ˆæœ€å¤š9å¼ ï¼‰</span></div>
      <div class="photo-grid" id="fl-photo-grid">
        <div class="photo-slot" onclick="addFlPhoto()"><span>ğŸ“·</span>æ·»åŠ ç…§ç‰‡</div>
      </div>
    </div>
    <div>
      <div style="font-size:12px;color:#5A7A5A;margin-bottom:6px">å¤‡æ³¨ <span style="color:#9DB89C">ï¼ˆé€‰å¡«ï¼Œæœ€å¤š100å­—ï¼‰</span> <span style="color:#9DB89C;float:right" id="notes-count">0/100</span></div>
      <textarea id="fl-notes" maxlength="100" rows="2"
        style="width:100%;background:#F7FAF7;border:1.5px solid rgba(46,125,50,.12);border-radius:10px;padding:10px 12px;font-size:14px;color:#1B2E1B;font-family:var(--sans);resize:none"
        placeholder="è¡¥å……è¯´æ˜â€¦"
        oninput="document.getElementById('notes-count').textContent=this.value.length+'/100'"></textarea>
    </div>`;

  body.innerHTML = html;

  // Render pre-existing data for edit mode
  if (type === 'growth' && flGrowthPoints.length) flGrowthPoints.forEach((p,i)=>renderGrowthCard(i));
  if (type === 'pest'   && flPesticides.length)   flPesticides.forEach((p,i)=>renderPestCard(i));
  if (type === 'water'  && flFertilizers.length)  flFertilizers.forEach((f,i)=>renderFertCard(i));
  if (type === 'issue') {
    setSeverity(flSeverity, document.querySelectorAll('.sev-btn')[{light:0,medium:1,heavy:2}[flSeverity]]);
  }
  updateFlPhotoGrid();
}

// â”€â”€ Growth points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addGrowthPoint() {
  if (flGrowthPoints.length >= 10) { toast('æœ€å¤šæ·»åŠ 10ä¸ªè§‚æµ‹ç‚¹'); return; }
  flGrowthPoints.push({no: flGrowthPoints.length+1, height:'', growth:'', leaves:'', stems:''});
  renderGrowthCard(flGrowthPoints.length-1);
  updateFlCounts();
}
function renderGrowthCard(i) {
  const p = flGrowthPoints[i];
  const container = document.getElementById('growth-points');
  const div = document.createElement('div');
  div.className = 'obs-card'; div.id = `gp-card-${i}`;
  div.innerHTML = `
    <div style="font-size:12px;font-weight:600;color:#2E7D32">è§‚æµ‹ç‚¹ ${i+1}</div>
    <div class="obs-card-del" onclick="removeGrowthPoint(${i})">Ã—</div>
    <div class="obs-grid">
      <div class="obs-field"><label>æ ªé«˜ï¼ˆcmï¼Œ0-999ï¼‰</label><input type="number" min="0" max="999" value="${p.height}" placeholder="æ ªé«˜" oninput="flGrowthPoints[${i}].height=parseFloat(this.value)||''"></div>
      <div class="obs-field"><label>æ—¥ç”Ÿé•¿é‡ï¼ˆcmï¼Œ0-99ï¼‰</label><input type="number" min="0" max="99" step="0.1" value="${p.growth}" placeholder="æ—¥ç”Ÿé•¿é‡" oninput="flGrowthPoints[${i}].growth=parseFloat(this.value)||''"></div>
      <div class="obs-field"><label>å¶æ•°ï¼ˆç‰‡ï¼‰</label><input type="number" min="0" max="99" value="${p.leaves}" placeholder="å¶æ•°" oninput="flGrowthPoints[${i}].leaves=parseInt(this.value)||''"></div>
      <div class="obs-field"><label>å°æ•°ï¼ˆå°ï¼‰</label><input type="number" min="0" max="99" value="${p.stems}" placeholder="å°æ•°" oninput="flGrowthPoints[${i}].stems=parseInt(this.value)||''"></div>
    </div>`;
  container.appendChild(div);
  updateFlCounts();
}
function removeGrowthPoint(i) {
  flGrowthPoints.splice(i,1);
  document.getElementById('growth-points').innerHTML = '';
  flGrowthPoints.forEach((p,idx)=>{ p.no=idx+1; renderGrowthCard(idx); });
  updateFlCounts();
}

// â”€â”€ Pesticides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addPesticide() {
  if (flPesticides.length >= 10) { toast('æœ€å¤šæ·»åŠ 10ç§å†œè¯'); return; }
  flPesticides.push({no: flPesticides.length+1, name:'', effect:'', amount:''});
  renderPestCard(flPesticides.length-1);
}
function renderPestCard(i) {
  const p = flPesticides[i];
  const container = document.getElementById('pest-list');
  const div = document.createElement('div');
  div.className = 'obs-card'; div.id = `pest-card-${i}`;
  div.innerHTML = `
    <div style="font-size:12px;font-weight:600;color:#E65100">å†œè¯ ${i+1}</div>
    <div class="obs-card-del" onclick="removePesticide(${i})">Ã—</div>
    <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
      <div class="obs-field"><label>å†œè¯åç§°</label><input type="text" value="${p.name}" placeholder="è¯·è¾“å…¥åç§°" oninput="flPesticides[${i}].name=this.value"></div>
      <div class="obs-field"><label>ä¸»è¦ä½œç”¨</label><input type="text" value="${p.effect}" placeholder="å¦‚ï¼šé˜²æ²»ç‰ç±³èŸ" oninput="flPesticides[${i}].effect=this.value"></div>
      <div class="obs-field"><label>ç”¨é‡ï¼ˆg/äº©ï¼Œ0-9999ï¼‰</label><input type="number" min="0" max="9999" value="${p.amount}" placeholder="ç”¨é‡" oninput="flPesticides[${i}].amount=parseFloat(this.value)||''"></div>
    </div>`;
  container.appendChild(div);
  document.getElementById('pest-count').textContent = flPesticides.length + '/10 ç§';
}
function removePesticide(i) {
  flPesticides.splice(i,1);
  document.getElementById('pest-list').innerHTML = '';
  flPesticides.forEach((p,idx)=>{ p.no=idx+1; renderPestCard(idx); });
  document.getElementById('pest-count').textContent = flPesticides.length + '/10 ç§';
}

// â”€â”€ Fertilizers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addFertilizer() {
  if (flFertilizers.length >= 10) { toast('æœ€å¤šæ·»åŠ 10ç§åŒ–è‚¥'); return; }
  flFertilizers.push({no: flFertilizers.length+1, name:'', amount:'', N:'', P:'', K:''});
  renderFertCard(flFertilizers.length-1);
}
function renderFertCard(i) {
  const f = flFertilizers[i];
  const container = document.getElementById('fert-list');
  const div = document.createElement('div');
  div.className = 'obs-card'; div.id = `fert-card-${i}`;
  div.innerHTML = `
    <div style="font-size:12px;font-weight:600;color:#0277BD">åŒ–è‚¥ ${i+1}</div>
    <div class="obs-card-del" onclick="removeFertilizer(${i})">Ã—</div>
    <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
      <div class="obs-field"><label>åŒ–è‚¥åç§°</label><input type="text" value="${f.name}" placeholder="å¦‚ï¼šå°¿ç´ " oninput="flFertilizers[${i}].name=this.value"></div>
      <div class="obs-grid">
        <div class="obs-field"><label>äº©ç”¨é‡ï¼ˆkgï¼‰</label><input type="number" min="0" max="9999" value="${f.amount}" placeholder="kg" oninput="flFertilizers[${i}].amount=parseFloat(this.value)||''"></div>
        <div class="obs-field"><label>æ°®å«é‡ï¼ˆ%ï¼‰</label><input type="number" min="0" max="100" value="${f.N}" placeholder="%" oninput="flFertilizers[${i}].N=parseFloat(this.value)||''"></div>
        <div class="obs-field"><label>ç£·å«é‡ï¼ˆ%ï¼‰</label><input type="number" min="0" max="100" value="${f.P}" placeholder="%" oninput="flFertilizers[${i}].P=parseFloat(this.value)||''"></div>
        <div class="obs-field"><label>é’¾å«é‡ï¼ˆ%ï¼‰</label><input type="number" min="0" max="100" value="${f.K}" placeholder="%" oninput="flFertilizers[${i}].K=parseFloat(this.value)||''"></div>
      </div>
    </div>`;
  container.appendChild(div);
  document.getElementById('fert-count').textContent = flFertilizers.length + '/10 ç§';
}
function removeFertilizer(i) {
  flFertilizers.splice(i,1);
  document.getElementById('fert-list').innerHTML = '';
  flFertilizers.forEach((f,idx)=>{ f.no=idx+1; renderFertCard(idx); });
  document.getElementById('fert-count').textContent = flFertilizers.length + '/10 ç§';
}

function updateFlCounts() {
  const gc = document.getElementById('growth-count');
  if (gc) gc.textContent = flGrowthPoints.length + '/10 ä¸ª';
}

// â”€â”€ Severity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSeverity(sev, el) {
  flSeverity = sev;
  document.querySelectorAll('.sev-btn').forEach(b=>b.className='sev-btn');
  if (el) el.className = `sev-btn active-${sev}`;
}

// â”€â”€ Photos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_PHOTOS = ['ğŸŒ¾','ğŸŒ¿','ğŸŒ½','ğŸŒ±','ğŸ“·','ğŸŒ¸','ğŸ€','ğŸŒ³','ğŸŒ»'];
function addFlPhoto() {
  if (flPhotos.length >= 9) { toast('æœ€å¤šæ·»åŠ 9å¼ ç…§ç‰‡'); return; }
  flPhotos.push(DEMO_PHOTOS[flPhotos.length % DEMO_PHOTOS.length]);
  updateFlPhotoGrid();
  toast('ç…§ç‰‡å·²æ·»åŠ ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
}
function removeFlPhoto(i) {
  flPhotos.splice(i,1);
  updateFlPhotoGrid();
}
function updateFlPhotoGrid() {
  const grid = document.getElementById('fl-photo-grid');
  if (!grid) return;
  let html = flPhotos.map((p,i)=>`
    <div style="aspect-ratio:1;border-radius:10px;background:#EEF6EE;display:flex;align-items:center;justify-content:center;font-size:32px;position:relative;border:1px solid rgba(46,125,50,.12)" onclick="toast('é¢„è§ˆç…§ç‰‡ ${i+1}')">
      ${p}
      <div onclick="event.stopPropagation();removeFlPhoto(${i})" style="position:absolute;top:3px;right:3px;width:18px;height:18px;background:#C62828;border-radius:50%;color:#FFFFFF;font-size:11px;display:flex;align-items:center;justify-content:center;cursor:pointer">Ã—</div>
    </div>`).join('');
  if (flPhotos.length < 9) {
    html += `<div class="photo-slot" onclick="addFlPhoto()"><span>ğŸ“·</span>æ·»åŠ ç…§ç‰‡</div>`;
  }
  grid.innerHTML = html;
}

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitFarmlog() {
  const fieldId = parseInt(document.getElementById('fl-field-sel').value);
  const date    = document.getElementById('fl-date').value;
  if (!fieldId) { toast('è¯·å…ˆé€‰æ‹©æ‰€å±åœ°å—'); return; }
  if (!date)    { toast('è¯·é€‰æ‹©ä½œä¸šæ—¥æœŸ'); return; }

  const field = DB.fields.find(f=>f.id===fieldId);
  const notes = (document.getElementById('fl-notes')||{}).value || '';
  let data = {};

  if (flCurrentType === 'diary') {
    const content = (document.getElementById('fl-diary-content')||{}).value || '';
    if (!content.trim()) { toast('è¯·å¡«å†™è®°äº‹å†…å®¹'); return; }
    data = { content };
  } else if (flCurrentType === 'growth') {
    if (!flGrowthPoints.length) { toast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè§‚æµ‹ç‚¹'); return; }
    if (flGrowthPoints.some(p=>!p.height && p.height!==0)) { toast('è¯·å¡«å†™å®Œæ•´çš„æ ªé«˜æ•°æ®'); return; }
    data = { points: flGrowthPoints };
  } else if (flCurrentType === 'pest') {
    if (!flPesticides.length) { toast('è¯·è‡³å°‘æ·»åŠ ä¸€ç§å†œè¯'); return; }
    if (flPesticides.some(p=>!p.name)) { toast('è¯·å¡«å†™å†œè¯åç§°'); return; }
    data = { pesticides: flPesticides };
  } else if (flCurrentType === 'water') {
    const waterAmt = parseFloat((document.getElementById('fl-water-amt')||{}).value);
    if (!waterAmt && waterAmt!==0) { toast('è¯·å¡«å†™äº©ç”¨æ°´é‡'); return; }
    data = { waterAmt, fertilizers: flFertilizers };
  } else if (flCurrentType === 'issue') {
    const desc = (document.getElementById('fl-issue-desc')||{}).value || '';
    const issueType = (document.getElementById('fl-issue-type')||{}).value || '';
    if (!desc.trim()) { toast('è¯·å¡«å†™é—®é¢˜æè¿°'); return; }
    if (!issueType)   { toast('è¯·é€‰æ‹©é—®é¢˜ç±»å‹'); return; }
    data = { desc, issueType, severity: flSeverity };
  }

  const now = new Date();
  const pad = n=>String(n).padStart(2,'0');
  const newRecord = {
    id: flEditId || Date.now(),
    type: flCurrentType,
    fieldId, fieldName: field.name,
    farm: 'åä¸œç¤ºèŒƒå†œåœº',
    crop: field.crop,
    date,
    recorder: 'ç‹å¤§æ˜',
    data, photos: [...flPhotos], notes
  };

  if (flEditId) {
    const idx = DB.farmlogs.findIndex(r=>r.id===flEditId);
    if (idx !== -1) DB.farmlogs[idx] = newRecord;
    toast('è®°å½•å·²æ›´æ–° âœ“');
    setTimeout(()=>{ flEditId=null; back(); }, 600);
    return;
  } else {
    DB.farmlogs.unshift(newRecord);
    toast('æäº¤æˆåŠŸ âœ“ï¼Œå¯ç»§ç»­æ·»åŠ ');
  }

  // Reset form for continued same-type entry
  flGrowthPoints=[]; flPesticides=[]; flFertilizers=[];
  flPhotos=[]; flSeverity='light';
  renderFlForm(flCurrentType);
}

function saveFarmlogDraft() { toast('è‰ç¨¿å·²ä¿å­˜'); }



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALLET DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DB.wallet = {
  balance: 5800.00,
  accounts: [
    { id:1, type:'corporate', icon:'ğŸ¢', label:'å¯¹å…¬é“¶è¡Œå¡', name:'åä¸œå†œä¸šç§‘æŠ€æœ‰é™å…¬å¸', bankName:'å»ºè®¾é“¶è¡Œ', cardNo:'**** **** **** 8888', tag:'å¯¹å…¬' },
    { id:2, type:'personal',  icon:'ğŸ’³', label:'ä¸ªäººé“¶è¡Œå¡', name:'ç‹å¤§æ˜', bankName:'å†œä¸šé“¶è¡Œ',  cardNo:'**** **** **** 6688', tag:'ä¸ªäºº' },
  ],
  transactions: [
    { id:1, type:'income',   time:'2024-01-15 14:32', label:'è®¢å•æ”¶å…¥', ref:'ORD202401150012', amt:+4380.00, status:'success' },
    { id:2, type:'withdraw', time:'2024-01-14 09:15', label:'æç°',     ref:'å»ºè®¾é“¶è¡Œ 8888',    amt:-1000.00, status:'success' },
    { id:3, type:'income',   time:'2024-01-12 16:48', label:'è®¢å•æ”¶å…¥', ref:'ORD202401120008', amt:+2560.00, status:'success' },
    { id:4, type:'withdraw', time:'2024-01-10 10:20', label:'æç°',     ref:'å†œä¸šé“¶è¡Œ 6688',    amt:-3000.00, status:'processing' },
    { id:5, type:'income',   time:'2024-01-08 11:05', label:'è®¢å•æ”¶å…¥', ref:'ORD202401080003', amt:+1980.00, status:'success' },
    { id:6, type:'income',   time:'2024-01-05 09:33', label:'è®¢å•æ”¶å…¥', ref:'ORD202401050001', amt:+3200.00, status:'success' },
    { id:7, type:'withdraw', time:'2023-12-28 14:10', label:'æç°',     ref:'å¾®ä¿¡æ”¯ä»˜',          amt:-2000.00, status:'success' },
    { id:8, type:'income',   time:'2023-12-22 08:55', label:'è®¢å•æ”¶å…¥', ref:'ORD202312220020', amt:+5100.00, status:'success' },
  ]
};

const ACCT_FORMS = {
  corporate: {
    title:'å¡«å†™å¯¹å…¬é“¶è¡Œå¡ä¿¡æ¯',
    fields:[
      {id:'f-corp-name',  label:'ä¼ä¸šåç§°',       type:'text', placeholder:'è¯·è¾“å…¥ä¼ä¸šåç§°',         required:true},
      {id:'f-corp-card',  label:'å¯¹å…¬é“¶è¡Œå¡å·',   type:'tel',  placeholder:'è¯·è¾“å…¥å¯¹å…¬é“¶è¡Œå¡å·',       required:true},
      {id:'f-corp-bank',  label:'å¼€æˆ·è¡Œåç§°',     type:'text', placeholder:'å¦‚ï¼šä¸­å›½å»ºè®¾é“¶è¡ŒåŒ—äº¬åˆ†è¡Œ', required:true},
      {id:'f-corp-phone', label:'é“¶è¡Œé¢„ç•™æ‰‹æœºå·', type:'tel',  placeholder:'è¯·è¾“å…¥é¢„ç•™æ‰‹æœºå·', required:true, maxlength:11},
      {id:'f-corp-sms',   label:'çŸ­ä¿¡éªŒè¯ç ',     type:'tel',  placeholder:'è¯·è¾“å…¥éªŒè¯ç ',     required:true, maxlength:6, smsBtn:true},
    ]
  },
  personal: {
    title:'å¡«å†™ä¸ªäººé“¶è¡Œå¡ä¿¡æ¯',
    fields:[
      {id:'f-per-holder', label:'æŒå¡äººå§“å',     type:'text', placeholder:'è¯·è¾“å…¥å§“å',      required:true},
      {id:'f-per-card',   label:'é“¶è¡Œå¡å·',       type:'tel',  placeholder:'è¯·è¾“å…¥é“¶è¡Œå¡å·',   required:true},
      {id:'f-per-bank',   label:'å¼€æˆ·è¡Œåç§°',     type:'text', placeholder:'å¦‚ï¼šä¸­å›½å†œä¸šé“¶è¡Œ', required:true},
      {id:'f-per-phone',  label:'é“¶è¡Œé¢„ç•™æ‰‹æœºå·', type:'tel',  placeholder:'è¯·è¾“å…¥é¢„ç•™æ‰‹æœºå·', required:true, maxlength:11},
      {id:'f-per-sms',    label:'çŸ­ä¿¡éªŒè¯ç ',     type:'tel',  placeholder:'è¯·è¾“å…¥éªŒè¯ç ',     required:true, maxlength:6, smsBtn:true},
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALLET NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navWallet() { navPage('wallet'); }

function navPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  const target = document.getElementById('page-' + page);
  if (target) target.classList.remove('hidden');
  document.getElementById('nav').style.display = 'none';
  pageStack.push(currentPage);
  currentPage = page;

  if (page === 'wallet')      initWalletHome();
  if (page === 'add-account') initAddAccount(null);
  if (page === 'tx-list')     initTxList('all');
  if (page === 'withdraw')    initWithdraw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALLET HOME  5.3.1.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initWalletHome() {
  const b = DB.wallet.balance;
  const s = b !== null ? b.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : 'â€”';
  document.getElementById('wallet-balance-amt').textContent = s;
  const ph = document.getElementById('profile-balance');
  if (ph) ph.textContent = 'ä½™é¢ Â¥' + s;

  // Preview 3 latest transactions
  document.getElementById('wallet-tx-preview').innerHTML =
    DB.wallet.transactions.slice(0,3).map(tx => renderTxItem(tx)).join('') ||
    '<div style="padding:20px;text-align:center;color:#9DB89C;font-size:13px">æš‚æ— æ˜ç»†</div>';

  renderWalletAccounts();
}

function renderWalletAccounts() {
  const list = DB.wallet.accounts;
  const el = document.getElementById('wallet-acct-list');
  if (!list.length) {
    el.innerHTML = '<div style="background:#FFFFFF;border:1px solid rgba(46,125,50,.10);border-radius:14px;padding:24px;text-align:center;color:#9DB89C;font-size:13px">æš‚æ— ç»‘å®šè´¦æˆ·</div>';
    return;
  }
  el.innerHTML = list.map(a => `
    <div class="acct-card">
      <div class="acct-card-icon" style="background:${acctBg(a.type)}">${a.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:500;color:#1B2E1B">${(a.type==='wechat'||a.type==='alipay') ? a.name : a.bankName+' å°¾å· '+a.cardNo.slice(-4)}</div>
        <div style="font-size:11px;color:#9DB89C;margin-top:2px">${a.name}</div>
      </div>
      <span class="badge" style="background:${acctBg(a.type)};color:${acctColor(a.type)};font-size:10px">${a.tag}</span>
      <button onclick="replaceAccount(${a.id})" style="margin-left:8px;padding:5px 12px;background:rgba(46,125,50,.08);color:#2E7D32;border-radius:8px;font-size:12px;font-weight:500;border:none;cursor:pointer;font-family:var(--sans)">æ›´æ¢</button>
    </div>`).join('');
}

function acctBg(t)    { return ({corporate:'rgba(255,111,0,.10)',personal:'rgba(46,125,50,.08)',wechat:'rgba(7,193,96,.10)',alipay:'rgba(21,101,192,.10)'})[t]||'rgba(46,125,50,.08)'; }
function acctColor(t) { return ({corporate:'#FF6F00',personal:'#2E7D32',wechat:'#07C160',alipay:'#1565C0'})[t]||'#2E7D32'; }

function replaceAccount(id) {
  const acct = DB.wallet.accounts.find(a => a.id === id);
  if (!acct) return;
  document.getElementById('add-acct-title').textContent = 'æ›´æ¢æ”¶æ¬¾è´¦æˆ·';
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById('page-add-account').classList.remove('hidden');
  pageStack.push(currentPage); currentPage = 'add-account';
  initAddAccount(acct);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD ACCOUNT  5.3.1.2 / 5.3.1.3
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedAcctType = null;
let editingAcctId = null;
const smsTimers = {};

function initAddAccount(editAcct) {
  editingAcctId = editAcct ? editAcct.id : null;
  selectedAcctType = editAcct ? editAcct.type : null;

  // Reset UI
  ['add-acct-step1','add-acct-step2','add-acct-success'].forEach((id,i) => {
    document.getElementById(id).style.display = i===0 ? 'block' : 'none';
  });
  setStepUI(1);
  document.querySelectorAll('.acct-type-card').forEach(c => c.classList.remove('selected'));

  if (editAcct) {
    const card = document.querySelector(`[onclick="selectAcctType('${editAcct.type}',this)"]`);
    if (card) card.classList.add('selected');
    // If bank type: jump straight to form
    if (editAcct.type === 'corporate' || editAcct.type === 'personal') {
      setTimeout(() => goAddAcctStep2(editAcct), 0);
    }
  }
}

function selectAcctType(type, el) {
  selectedAcctType = type;
  document.querySelectorAll('.acct-type-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

function goAddAcctStep2(prefill) {
  if (!selectedAcctType) { toast('è¯·é€‰æ‹©è´¦æˆ·ç±»å‹'); return; }

  if (selectedAcctType === 'wechat' || selectedAcctType === 'alipay') {
    const isWx = selectedAcctType === 'wechat';
    document.getElementById('auth-icon').textContent  = isWx ? 'ğŸ’š' : 'ğŸ”µ';
    document.getElementById('auth-title').textContent = (isWx ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®') + 'æˆæƒç»‘å®š';
    document.querySelectorAll('#modal-auth .modal-sheet > div')[3].textContent =
      `å³å°†è·³è½¬${isWx?'å¾®ä¿¡':'æ”¯ä»˜å®'}è¿›è¡Œæˆæƒï¼ŒæˆæƒæˆåŠŸåè‡ªåŠ¨ç»‘å®šã€‚`;
    openModal('modal-auth'); return;
  }

  const formDef = ACCT_FORMS[selectedAcctType];
  if (!formDef) return;

  document.getElementById('add-acct-step1').style.display = 'none';
  document.getElementById('add-acct-step2').style.display = 'block';
  document.getElementById('add-acct-form-title').textContent = formDef.title;
  setStepUI(2);

  document.getElementById('add-acct-form').innerHTML =
    formDef.fields.map(f => `
      <div style="margin-bottom:14px">
        <div style="font-size:12px;color:#5A7A5A;margin-bottom:6px">${f.label}${f.required?' <span style="color:#C62828">*</span>':''}</div>
        <div class="field" style="padding:10px 14px">
          <input type="${f.type}" id="${f.id}" ${f.maxlength?`maxlength="${f.maxlength}"`:''}
            placeholder="${f.placeholder}" style="flex:1;font-size:14px;color:#1B2E1B">
          ${f.smsBtn?`<button onclick="sendSmsCode('${f.id}')" id="sms-btn-${f.id}"
            style="white-space:nowrap;color:#FF6F00;font-size:12px;font-weight:600;font-family:var(--sans);background:none;border:none;cursor:pointer;padding-left:8px">è·å–éªŒè¯ç </button>`:''}
        </div>
      </div>`).join('') +
    `<button class="btn btn-orange btn-full" style="margin-top:8px;height:48px;border-radius:12px;font-size:15px;font-weight:600" onclick="confirmBindAccount()">ç¡®è®¤ç»‘å®š</button>
     <div style="font-size:11px;color:#9DB89C;text-align:center;margin-top:10px;line-height:1.6">è´¦æˆ·ä¿¡æ¯åŠ å¯†ä¼ è¾“ï¼Œå®‰å…¨æœ‰ä¿éšœ</div>`;

  // Pre-fill for edit
  const acct = prefill && typeof prefill === 'object' ? prefill : null;
  if (acct) {
    if (selectedAcctType === 'corporate') {
      const n=document.getElementById('f-corp-name'); if(n) n.value=acct.name;
      const c=document.getElementById('f-corp-card'); if(c){c.value=acct.cardNo;}
      const b=document.getElementById('f-corp-bank'); if(b) b.value=acct.bankName;
    } else {
      const h=document.getElementById('f-per-holder'); if(h) h.value=acct.name;
      const c=document.getElementById('f-per-card');   if(c){c.value=acct.cardNo;}
      const b=document.getElementById('f-per-bank');   if(b) b.value=acct.bankName;
    }
  }
}

function setStepUI(step) {
  const d1=document.getElementById('step1-dot'), d2=document.getElementById('step2-dot'), ln=document.getElementById('step-line');
  if(!d1) return;
  d1.className = step===1 ? 'step-dot active' : 'step-dot done';
  d2.className = step===2 ? 'step-dot active' : 'step-dot pending';
  ln.className = step===2 ? 'step-line done' : 'step-line pending';
}

function sendSmsCode(fieldId) {
  if (smsTimers[fieldId]) return;
  toast('éªŒè¯ç å·²å‘é€'); let t = 60;
  const btn = document.getElementById('sms-btn-' + fieldId);
  if (btn) { btn.textContent = `${t}s`; btn.style.color='#9DB89C'; }
  smsTimers[fieldId] = setInterval(() => {
    t--; if (btn) btn.textContent = `${t}s`;
    if (t <= 0) { clearInterval(smsTimers[fieldId]); delete smsTimers[fieldId]; if(btn){btn.textContent='è·å–éªŒè¯ç ';btn.style.color='#FF6F00';} }
  }, 1000);
}

function confirmBindAccount() {
  const formDef = ACCT_FORMS[selectedAcctType]; if(!formDef) return;
  for (const f of formDef.fields) {
    const el = document.getElementById(f.id);
    if (f.required && el && !el.value.trim()) {
      el.closest('.field').style.border='1.5px solid #C62828';
      toast('è¯·å¡«å†™' + f.label); return;
    }
    if(el) el.closest('.field').style.border='';
  }
  let newAcct;
  if (selectedAcctType === 'corporate') {
    const raw=(document.getElementById('f-corp-card').value||'').replace(/\s/g,'');
    newAcct = { type:'corporate', icon:'ğŸ¢', label:'å¯¹å…¬é“¶è¡Œå¡', tag:'å¯¹å…¬',
      name: document.getElementById('f-corp-name').value,
      bankName: document.getElementById('f-corp-bank').value,
      cardNo: raw.length>=4 ? '**** **** **** '+raw.slice(-4) : raw };
  } else {
    const raw=(document.getElementById('f-per-card').value||'').replace(/\s/g,'');
    newAcct = { type:'personal', icon:'ğŸ’³', label:'ä¸ªäººé“¶è¡Œå¡', tag:'ä¸ªäºº',
      name: document.getElementById('f-per-holder').value,
      bankName: document.getElementById('f-per-bank').value,
      cardNo: raw.length>=4 ? '**** **** **** '+raw.slice(-4) : raw };
  }
  if (editingAcctId) {
    const idx=DB.wallet.accounts.findIndex(a=>a.id===editingAcctId);
    if(idx!==-1){newAcct.id=editingAcctId; DB.wallet.accounts[idx]=newAcct;}
    document.getElementById('add-acct-success-title').textContent='æ›´æ¢æˆåŠŸ';
    document.getElementById('add-acct-success-desc').textContent='æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯å·²æ›´æ–°ã€‚';
  } else {
    newAcct.id=Date.now(); DB.wallet.accounts.push(newAcct);
    document.getElementById('add-acct-success-title').textContent='ç»‘å®šæˆåŠŸ';
    document.getElementById('add-acct-success-desc').textContent='æ”¶æ¬¾è´¦æˆ·å·²æˆåŠŸç»‘å®šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥è´¦æˆ·è¿›è¡Œæç°æ“ä½œã€‚';
  }
  document.getElementById('add-acct-step2').style.display='none';
  document.getElementById('add-acct-success').style.display='block';
  toast(editingAcctId?'è´¦æˆ·å·²æ›´æ–° âœ“':'ç»‘å®šæˆåŠŸ âœ“');
}

let authPendingType = null;
function confirmAuth() {
  authPendingType = selectedAcctType;
  closeModal('modal-auth'); toast('æ­£åœ¨è·³è½¬æˆæƒâ€¦');
  setTimeout(() => {
    const isWx = authPendingType==='wechat';
    const newAcct = { id:Date.now(), type:authPendingType, icon:isWx?'ğŸ’š':'ğŸ”µ',
      label:isWx?'å¾®ä¿¡æ”¯ä»˜':'æ”¯ä»˜å®', tag:isWx?'å¾®ä¿¡':'æ”¯ä»˜å®',
      name:`ç‹å¤§æ˜ï¼ˆ${isWx?'å¾®ä¿¡':'æ”¯ä»˜å®'}ï¼‰`, bankName:'', cardNo:'' };
    DB.wallet.accounts=DB.wallet.accounts.filter(a=>a.type!==authPendingType);
    DB.wallet.accounts.push(newAcct);
    document.getElementById('add-acct-step1').style.display='none';
    document.getElementById('add-acct-success-title').textContent=(isWx?'å¾®ä¿¡':'æ”¯ä»˜å®')+'ç»‘å®šæˆåŠŸ';
    document.getElementById('add-acct-success-desc').textContent=`${isWx?'å¾®ä¿¡':'æ”¯ä»˜å®'}è´¦æˆ·å·²æˆæƒç»‘å®šï¼Œå¯ç”¨äºæç°ã€‚`;
    document.getElementById('add-acct-success').style.display='block';
    toast((isWx?'å¾®ä¿¡':'æ”¯ä»˜å®')+'è´¦æˆ·ç»‘å®šæˆåŠŸ âœ“');
  }, 1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSACTION LIST  5.3.1.4
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTxList(filter) {
  filterTx(filter || 'all', document.getElementById('tx-chip-'+(filter||'all')) || document.createElement('div'));
}

function filterTx(type, el) {
  document.querySelectorAll('[id^="tx-chip-"]').forEach(c=>c.classList.remove('active'));
  if(el) el.classList.add('active');
  const list = type==='all' ? DB.wallet.transactions : DB.wallet.transactions.filter(t=>t.type===type);
  const c = document.getElementById('tx-full-list');
  c.innerHTML = list.length ? `<div class="card">${list.map(renderTxItem).join('')}</div>`
    : '<div style="padding:40px;text-align:center;color:#9DB89C;font-size:13px">æš‚æ— è®°å½•</div>';
}

function renderTxItem(tx) {
  const pos = tx.amt > 0;
  const amtStr = (pos?'+':'')+' Â¥'+Math.abs(tx.amt).toFixed(2);
  const badge = tx.status==='processing'
    ? `<span style="font-size:10px;color:#E65100;background:rgba(230,81,0,.08);padding:1px 6px;border-radius:6px">å¤„ç†ä¸­</span>`
    : `<span style="font-size:10px;color:#2E7D32;background:rgba(46,125,50,.08);padding:1px 6px;border-radius:6px">æˆåŠŸ</span>`;
  return `<div class="tx-item">
    <div class="tx-icon" style="background:${pos?'rgba(46,125,50,.10)':'rgba(255,111,0,.10)'}">${pos?'ğŸ“ˆ':'ğŸ’¸'}</div>
    <div style="flex:1;min-width:0">
      <div style="font-size:14px;font-weight:500;color:#1B2E1B">${tx.label}</div>
      <div style="font-size:11px;color:#9DB89C;margin-top:2px">${tx.time}</div>
      <div style="font-size:11px;color:#9DB89C">${tx.ref}</div>
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div style="font-family:var(--mono);font-size:16px;font-weight:600;color:${pos?'#2E7D32':'#1B2E1B'}">${amtStr}</div>
      <div style="margin-top:4px">${badge}</div>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WITHDRAW  5.3.1.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedWithdrawAcctId = null;

function initWithdraw() {
  const s = DB.wallet.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  document.getElementById('withdraw-balance').textContent = s;
  document.getElementById('withdraw-amt').value = '';
  document.getElementById('withdraw-err').textContent = '';

  const container = document.getElementById('withdraw-acct-list');
  const accts = DB.wallet.accounts;
  if (!accts.length) {
    selectedWithdrawAcctId = null;
    container.innerHTML = `
      <div style="background:#FFF8E1;border:1px solid #FFB74D;border-radius:10px;padding:14px;font-size:13px;color:#E65100;margin-bottom:12px">
        âš ï¸ è¯·å…ˆç»‘å®šæ”¶æ¬¾è´¦æˆ·</div>
      <button class="btn btn-ghost btn-full" style="height:42px;border-radius:10px" onclick="navPage('add-account')">å»ç»‘å®š</button>`;
    return;
  }
  selectedWithdrawAcctId = accts[0].id;
  container.innerHTML = accts.map((a,i) => {
    const sel = i===0;
    return `<div class="acct-card" id="w-acct-${a.id}" onclick="selectWithdrawAcct(${a.id})"
      style="cursor:pointer;border-color:${sel?'#FF6F00':'rgba(46,125,50,.10)'};box-shadow:${sel?'0 0 0 2px rgba(255,111,0,.15)':'none'}">
      <div style="width:20px;height:20px;border-radius:50%;border:2px solid ${sel?'#FF6F00':'#C8E6C9'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <div style="width:10px;height:10px;border-radius:50%;background:${sel?'#FF6F00':'transparent'}"></div>
      </div>
      <div class="acct-card-icon" style="background:${acctBg(a.type)}">${a.icon}</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:500;color:#1B2E1B">${(a.type==='wechat'||a.type==='alipay')?a.name:a.bankName+' '+a.cardNo}</div>
        <div style="font-size:11px;color:#9DB89C">${a.tag}</div>
      </div>
    </div>`;
  }).join('');
}

function selectWithdrawAcct(id) {
  selectedWithdrawAcctId = id;
  DB.wallet.accounts.forEach(a => {
    const card = document.getElementById('w-acct-'+a.id); if (!card) return;
    const sel = a.id===id;
    card.style.borderColor = sel?'#FF6F00':'rgba(46,125,50,.10)';
    card.style.boxShadow   = sel?'0 0 0 2px rgba(255,111,0,.15)':'none';
    const ring=card.querySelector('div:first-child'), dot=ring&&ring.querySelector('div');
    if(ring) ring.style.borderColor=sel?'#FF6F00':'#C8E6C9';
    if(dot)  dot.style.background  =sel?'#FF6F00':'transparent';
  });
}

function fillAllWithdraw() {
  document.getElementById('withdraw-amt').value = DB.wallet.balance.toFixed(2);
  document.getElementById('withdraw-err').textContent = '';
}

function validateWithdraw() {
  const v = parseFloat(document.getElementById('withdraw-amt').value);
  document.getElementById('withdraw-err').textContent =
    (v && v > DB.wallet.balance) ? 'ä½™é¢ä¸è¶³ï¼Œæç°é‡‘é¢ä¸èƒ½è¶…è¿‡å¯æç°ä½™é¢' : '';
}

function submitWithdraw() {
  const amt = parseFloat(document.getElementById('withdraw-amt').value);
  if (!amt || amt <= 0)          { toast('è¯·è¾“å…¥æç°é‡‘é¢'); return; }
  if (amt > DB.wallet.balance)   { document.getElementById('withdraw-err').textContent='ä½™é¢ä¸è¶³'; return; }
  if (!DB.wallet.accounts.length){ toast('è¯·å…ˆç»‘å®šæ”¶æ¬¾è´¦æˆ·'); return; }
  if (!selectedWithdrawAcctId)   { toast('è¯·é€‰æ‹©æ”¶æ¬¾è´¦æˆ·'); return; }

  const a = DB.wallet.accounts.find(x=>x.id===selectedWithdrawAcctId);
  const ref = a ? ((a.type==='wechat'||a.type==='alipay') ? a.name : a.bankName+' '+a.cardNo.slice(-4)) : 'â€”';
  DB.wallet.transactions.unshift({
    id:Date.now(), type:'withdraw',
    time: new Date().toLocaleString('zh-CN',{hour12:false}).replace(/\//g,'-').replace(/(\d{4}-\d{2}-\d{2})\s/,'$1 ').slice(0,16),
    label:'æç°', ref, amt:-amt, status:'processing'
  });
  DB.wallet.balance = Math.round((DB.wallet.balance - amt) * 100) / 100;
  openModal('modal-withdraw-success');
}


function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let toastTimer = null;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2200);
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(mo => {
  mo.addEventListener('click', e => { if (e.target === mo) mo.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  // Show login, hide nav
  document.getElementById('nav').style.display = 'none';
  document.getElementById('page-login').classList.remove('hidden');

  // Set date
  const now = new Date();
  const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  if (document.getElementById('home-date')) {
    document.getElementById('home-date').textContent =
      `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${days[now.getDay()]}`;
  }

  // Cleanup tracking when leaving tracking page
  const observer = new MutationObserver(() => {
    if (document.getElementById('page-tracking').classList.contains('hidden')) {
      if (trackInterval) { clearInterval(trackInterval); trackInterval = null; }
    }
  });
  observer.observe(document.getElementById('page-tracking'), { attributes: true });
})();
</script>
</body>
</html>
